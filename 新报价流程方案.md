# 🔄 新报价流程方案

## 📋 方案概述

### 核心思路

**分离"询价"和"订单"两个阶段**：

```
阶段 1: 询价阶段（不是真实订单）
客户上传文件 → 提交询价 → 存储到 Metaobject → 客服报价

阶段 2: 下单阶段（真实订单）
客户确认报价 → 点击"立即下单" → 创建 Shopify 订单 → 进入购物车 → 付款
```

---

## 🆚 旧方案 vs 新方案对比

| 对比项 | 旧方案（当前） | 新方案（推荐） |
|-------|-------------|--------------|
| **询价方式** | 添加到购物车 | 独立询价页面 |
| **数据存储** | 购物车 + Metaobject | 仅 Metaobject |
| **客服操作** | 修改 Metaobject | 修改 Metaobject |
| **客户查看** | 购物车页面 | 独立订单页面 |
| **下单时机** | 询价时已在购物车 | 确认报价后才加入购物车 |
| **是否符合 Shopify 规则** | ⚠️ 灰色地带 | ✅ 完全符合 |
| **用户体验** | ⚠️ 混淆（购物车有未报价商品） | ✅ 清晰（询价和订单分离） |

---

## 🔄 新流程详解

### 阶段 1️⃣：询价阶段

#### 步骤 1: 客户提交询价

**页面**: `templates/page.quote-request.liquid`（新建）

```
客户操作:
1. 上传 3D 模型文件
2. 填写参数（数量、材质等）
3. 点击"提交询价"
```

**数据流**:
```javascript
前端 (model-uploader.js)
  ↓ POST /api/upload-file
后端 (api/upload-file.js)
  ↓ 上传文件到 Shopify Files
  ↓ 创建 Metaobject (status: "Pending")
返回 → 询价单号 (quoteId)
  ↓
前端跳转 → /pages/my-quotes?id=quoteId
```

**关键变化**:
- ❌ **不再**添加到购物车
- ✅ 直接创建 Metaobject
- ✅ 跳转到"我的询价"页面

---

#### 步骤 2: 客户查看询价状态

**页面**: `templates/page.my-quotes.liquid`（新建）

**显示内容**:
```
┌─────────────────────────────────────┐
│ 我的询价单                           │
├─────────────────────────────────────┤
│ 询价单号: Q20250129001              │
│ 状态: 🟡 待报价                     │
│ 提交时间: 2025-01-29 10:30         │
│                                     │
│ 文件列表:                           │
│ • model.step (667 KB)              │
│                                     │
│ 参数:                               │
│ • 数量: 100                        │
│ • 材质: ABS                        │
│                                     │
│ 💬 客服正在为您报价，请稍候...      │
└─────────────────────────────────────┘
```

**状态说明**:
- 🟡 **待报价** (Pending): 客服还未报价
- 🟢 **已报价** (Quoted): 客服已报价，可以下单
- 🔴 **已拒绝** (Rejected): 无法生产

---

#### 步骤 3: 客服添加报价

**页面**: `templates/page.admin-dashboard.liquid`（修改）

**操作**:
```
1. 查看待报价订单
2. 点击"添加报价"
3. 输入报价金额和备注
4. 点击"发送报价"
```

**数据流**:
```javascript
前端 (admin-dashboard)
  ↓ PATCH /api/quotes?handle=quoteId
后端 (api/quotes-restored.js)
  ↓ 更新 Metaobject:
      status: "Quoted"
      amount: 1500
      note: "报价说明"
  ↓
前端 → 调用 /api/send-email
  ↓ 发送报价邮件给客户
```

**关键变化**:
- ✅ 仍然修改 Metaobject（不涉及 Shopify 订单）
- ✅ 发送邮件通知客户

---

### 阶段 2️⃣：下单阶段

#### 步骤 4: 客户确认报价

**页面**: `templates/page.my-quotes.liquid`

**客户收到报价后，页面显示**:
```
┌─────────────────────────────────────┐
│ 询价单号: Q20250129001              │
│ 状态: 🟢 已报价                     │
│                                     │
│ 💰 报价金额: ¥1,500.00             │
│                                     │
│ 📝 客服备注:                        │
│ 根据您的要求，我们报价如下...       │
│                                     │
│ ┌─────────────────────────────┐   │
│ │  🛒 立即下单                 │   │
│ └─────────────────────────────┘   │
│                                     │
│ 点击"立即下单"后将创建正式订单      │
└─────────────────────────────────────┘
```

---

#### 步骤 5: 创建真实订单

**触发**: 客户点击"立即下单"

**数据流**:
```javascript
前端 (my-quotes.liquid)
  ↓ 点击"立即下单"
  ↓ 调用 createOrder(quoteId)
  ↓
  ↓ 方案 A: 使用 Ajax API
  ↓ POST /cart/add.js
  ↓ {
  ↓   items: [{
  ↓     id: productVariantId,  // 通用"定制产品"的变体 ID
  ↓     quantity: 1,
  ↓     properties: {
  ↓       _quoteId: "Q20250129001",
  ↓       _amount: "1500",
  ↓       _files: "model.step",
  ↓       _note: "报价说明"
  ↓     }
  ↓   }]
  ↓ }
  ↓
  ↓ 方案 B: 使用 Draft Order API
  ↓ POST /api/create-draft-order
  ↓ 后端调用 Shopify GraphQL
  ↓ draftOrderCreate(...)
  ↓ 返回 invoiceUrl
  ↓
跳转 → /cart 或 /checkout
```

**关键点**:
- ✅ **此时才创建** Shopify 订单
- ✅ 订单金额 = 客服报价的金额
- ✅ 订单状态 = 待付款（Shopify 默认）
- ✅ 订单属性包含询价单信息

---

## 🛠️ 实施方案

### 方案 A: 使用购物车 API（推荐，简单）

#### 优势
- ✅ 实施简单（前端 JavaScript 即可）
- ✅ 无需额外 API 权限
- ✅ 客户可以在购物车修改数量（如果需要）
- ✅ 标准的 Shopify 结账流程

#### 劣势
- ⚠️ 需要创建一个"通用定制产品"
- ⚠️ 价格需要通过 Line Item Properties 传递（显示可能不完美）

#### 实施步骤

**1. 创建通用产品**

在 Shopify 后台创建产品：
- 名称: "定制产品"
- 价格: ¥0.01（占位价格）
- SKU: CUSTOM-QUOTE
- 说明: 此产品用于定制订单，实际价格以报价为准

**2. 前端代码**

```javascript
// templates/page.my-quotes.liquid

async function createOrderFromQuote(quote) {
  try {
    // 添加到购物车
    const response = await fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        items: [{
          id: 'YOUR_PRODUCT_VARIANT_ID',  // 通用定制产品的变体 ID
          quantity: 1,
          properties: {
            '询价单号': quote.handle,
            '报价金额': `¥${quote.amount}`,
            '文件': quote.files.map(f => f.fileName).join(', '),
            '备注': quote.note || '',
            '_quoteId': quote.handle,  // 下划线开头的属性不显示给客户
            '_metaobjectId': quote.id
          }
        }]
      })
    });

    if (response.ok) {
      // 更新 Metaobject 状态为"已下单"
      await fetch(`${API_BASE}/quotes?handle=${quote.handle}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: 'Ordered',
          orderedAt: new Date().toISOString()
        })
      });

      // 跳转到购物车
      window.location.href = '/cart';
    } else {
      alert('添加到购物车失败，请重试');
    }
  } catch (error) {
    console.error('创建订单失败:', error);
    alert('创建订单失败，请联系客服');
  }
}
```

**3. 购物车显示**

购物车会显示：
```
┌─────────────────────────────────────┐
│ 定制产品                            │
│ ¥0.01                              │
│                                     │
│ 询价单号: Q20250129001             │
│ 报价金额: ¥1,500.00                │
│ 文件: model.step                   │
└─────────────────────────────────────┘
```

**问题**: 显示的价格是 ¥0.01，不是报价金额

**解决方案**: 
- 方案 1: 在产品描述中说明"实际价格以报价为准，请联系客服修改"
- 方案 2: 使用 Draft Order API（见方案 B）

---

### 方案 B: 使用 Draft Order API（推荐，完美）

#### 优势
- ✅ 可以设置任意价格
- ✅ 订单显示完美（价格正确）
- ✅ 客户体验最佳
- ✅ 更专业

#### 劣势
- ⚠️ 需要额外 API 权限（`write_draft_orders`）
- ⚠️ 需要后端 API
- ⚠️ 实施稍复杂

#### 实施步骤

**1. 添加 API 权限**

在 Shopify 后台：
1. 设置 → 应用和销售渠道 → 开发应用
2. 选择你的应用
3. 配置 Admin API 访问范围
4. 添加权限：
   - ✅ `write_draft_orders`（创建草稿订单）
   - ✅ `read_draft_orders`（读取草稿订单）
5. 保存并重新安装应用

**2. 创建后端 API**

```javascript
// api/create-draft-order.js

/**
 * 从询价单创建 Shopify 草稿订单
 * 
 * 草稿订单 = 客服创建的订单，发送给客户确认和付款
 * 优势：可以设置任意价格，不受产品价格限制
 */

async function shopGql(query, variables) {
  const storeDomain = process.env.SHOPIFY_STORE_DOMAIN;
  const accessToken = process.env.SHOPIFY_ACCESS_TOKEN;
  
  const endpoint = `https://${storeDomain}/admin/api/2024-07/graphql.json`;
  const resp = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Shopify-Access-Token': accessToken,
    },
    body: JSON.stringify({ query, variables }),
  });
  
  return await resp.json();
}

export default async function handler(req, res) {
  // CORS
  res.setHeader('Access-Control-Allow-Origin', 'https://sain-pdc-test.myshopify.com');
  res.setHeader('Access-Control-Allow-Methods', 'POST,OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    return res.status(204).end();
  }
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }
  
  const { quoteId, customerEmail, amount, files, note } = req.body;
  
  try {
    // 1. 查找或创建客户
    const customerQuery = `
      query($email: String!) {
        customers(first: 1, query: $email) {
          edges {
            node {
              id
              email
            }
          }
        }
      }
    `;
    
    const customerResult = await shopGql(customerQuery, {
      email: `email:${customerEmail}`
    });
    
    let customerId = null;
    if (customerResult.data.customers.edges.length > 0) {
      customerId = customerResult.data.customers.edges[0].node.id;
    }
    
    // 2. 创建草稿订单
    const draftOrderMutation = `
      mutation($input: DraftOrderInput!) {
        draftOrderCreate(input: $input) {
          draftOrder {
            id
            invoiceUrl
            name
          }
          userErrors {
            field
            message
          }
        }
      }
    `;
    
    const lineItems = [{
      title: `定制产品 - ${quoteId}`,
      quantity: 1,
      originalUnitPrice: amount,
      customAttributes: [
        { key: "询价单号", value: quoteId },
        { key: "文件", value: files.map(f => f.fileName).join(', ') },
        { key: "备注", value: note || '' }
      ]
    }];
    
    const draftOrderInput = {
      lineItems: lineItems,
      email: customerEmail,
      note: `询价单: ${quoteId}`,
      tags: ['quote', quoteId]
    };
    
    if (customerId) {
      draftOrderInput.customerId = customerId;
    }
    
    const draftOrderResult = await shopGql(draftOrderMutation, {
      input: draftOrderInput
    });
    
    if (draftOrderResult.data.draftOrderCreate.userErrors.length > 0) {
      console.error('创建草稿订单失败:', draftOrderResult.data.draftOrderCreate.userErrors);
      return res.status(400).json({
        error: '创建订单失败',
        details: draftOrderResult.data.draftOrderCreate.userErrors
      });
    }
    
    const draftOrder = draftOrderResult.data.draftOrderCreate.draftOrder;
    
    // 3. 返回结果
    return res.json({
      success: true,
      draftOrderId: draftOrder.id,
      draftOrderName: draftOrder.name,
      invoiceUrl: draftOrder.invoiceUrl,  // 客户付款链接
      message: '订单创建成功'
    });
    
  } catch (error) {
    console.error('创建草稿订单失败:', error);
    return res.status(500).json({
      error: '服务器错误',
      message: error.message
    });
  }
}
```

**3. 前端代码**

```javascript
// templates/page.my-quotes.liquid

async function createOrderFromQuote(quote) {
  try {
    // 显示加载状态
    const btn = document.getElementById('order-btn');
    btn.disabled = true;
    btn.textContent = '创建订单中...';
    
    // 调用后端 API 创建草稿订单
    const response = await fetch(`${API_BASE}/create-draft-order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        quoteId: quote.handle,
        customerEmail: quote.email,
        amount: quote.amount,
        files: quote.files,
        note: quote.note
      })
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      // 更新 Metaobject 状态
      await fetch(`${API_BASE}/quotes?handle=${quote.handle}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: 'Ordered',
          draftOrderId: result.draftOrderId,
          orderedAt: new Date().toISOString()
        })
      });
      
      // 跳转到付款页面
      window.location.href = result.invoiceUrl;
    } else {
      alert('创建订单失败: ' + (result.error || '未知错误'));
      btn.disabled = false;
      btn.textContent = '🛒 立即下单';
    }
    
  } catch (error) {
    console.error('创建订单失败:', error);
    alert('创建订单失败，请联系客服');
    btn.disabled = false;
    btn.textContent = '🛒 立即下单';
  }
}
```

**4. 客户体验**

```
客户点击"立即下单"
  ↓
显示"创建订单中..."
  ↓
后端创建草稿订单
  ↓
跳转到 Shopify 付款页面
  ↓
订单显示：
┌─────────────────────────────────────┐
│ 订单 #D1001                         │
│                                     │
│ 定制产品 - Q20250129001            │
│ 数量: 1                            │
│ 单价: ¥1,500.00                    │
│ 小计: ¥1,500.00                    │
│                                     │
│ 总计: ¥1,500.00                    │
│                                     │
│ [继续付款]                          │
└─────────────────────────────────────┘
```

**优势**:
- ✅ 价格完全正确（¥1,500.00）
- ✅ 显示完美
- ✅ 标准的 Shopify 结账流程

---

### 方案 C: 混合方案（平衡）

**思路**: 
- 小额订单（< ¥500）: 使用购物车 API（方案 A）
- 大额订单（≥ ¥500）: 使用 Draft Order API（方案 B）

**优势**:
- ✅ 灵活
- ✅ 小订单快速处理
- ✅ 大订单体验更好

---

## 📊 方案对比总结

| 对比项 | 方案 A: 购物车 API | 方案 B: Draft Order API | 方案 C: 混合 |
|-------|------------------|----------------------|------------|
| **实施难度** | ⭐ 简单 | ⭐⭐⭐ 中等 | ⭐⭐⭐⭐ 复杂 |
| **价格显示** | ⚠️ 不准确（¥0.01） | ✅ 完美（报价金额） | ✅ 部分完美 |
| **API 权限** | ✅ 无需额外权限 | ⚠️ 需要 `write_draft_orders` | ⚠️ 需要权限 |
| **用户体验** | ⭐⭐⭐ 良好 | ⭐⭐⭐⭐⭐ 完美 | ⭐⭐⭐⭐ 很好 |
| **开发时间** | 1-2 小时 | 3-4 小时 | 4-5 小时 |
| **推荐度** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

---

## 🎯 推荐实施顺序

### 阶段 1: 基础功能（1-2 天）

1. ✅ 修改前端：移除购物车逻辑
2. ✅ 创建"我的询价"页面
3. ✅ 使用方案 A（购物车 API）实现下单
4. ✅ 测试完整流程

### 阶段 2: 优化体验（2-3 天）

1. ✅ 添加 `write_draft_orders` 权限
2. ✅ 实现方案 B（Draft Order API）
3. ✅ 替换方案 A
4. ✅ 测试并上线

### 阶段 3: 高级功能（可选）

1. ✅ 添加订单状态追踪
2. ✅ 添加订单历史记录
3. ✅ 添加订单搜索功能

---

## 📝 需要创建的文件

### 新建文件

1. **templates/page.quote-request.liquid** - 询价提交页面
2. **templates/page.my-quotes.liquid** - 我的询价页面
3. **api/create-draft-order.js** - 创建草稿订单 API（方案 B）

### 修改文件

1. **assets/model-uploader.js** - 移除购物车逻辑
2. **templates/page.admin-dashboard.liquid** - 保持不变（或小改）
3. **api/quotes-restored.js** - 添加新状态（Ordered）

### 删除文件

1. **templates/cart.quote.liquid** - 不再需要（不使用购物车）

---

## 🚀 下一步

你想要：

**选项 A**: 我帮你实现方案 A（购物车 API，快速上线）  
**选项 B**: 我帮你实现方案 B（Draft Order API，完美体验）  
**选项 C**: 先看看详细的代码示例再决定

请告诉我你的选择！ 🎯

