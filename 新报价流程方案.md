# ğŸ”„ æ–°æŠ¥ä»·æµç¨‹æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

### æ ¸å¿ƒæ€è·¯

**åˆ†ç¦»"è¯¢ä»·"å’Œ"è®¢å•"ä¸¤ä¸ªé˜¶æ®µ**ï¼š

```
é˜¶æ®µ 1: è¯¢ä»·é˜¶æ®µï¼ˆä¸æ˜¯çœŸå®è®¢å•ï¼‰
å®¢æˆ·ä¸Šä¼ æ–‡ä»¶ â†’ æäº¤è¯¢ä»· â†’ å­˜å‚¨åˆ° Metaobject â†’ å®¢æœæŠ¥ä»·

é˜¶æ®µ 2: ä¸‹å•é˜¶æ®µï¼ˆçœŸå®è®¢å•ï¼‰
å®¢æˆ·ç¡®è®¤æŠ¥ä»· â†’ ç‚¹å‡»"ç«‹å³ä¸‹å•" â†’ åˆ›å»º Shopify è®¢å• â†’ è¿›å…¥è´­ç‰©è½¦ â†’ ä»˜æ¬¾
```

---

## ğŸ†š æ—§æ–¹æ¡ˆ vs æ–°æ–¹æ¡ˆå¯¹æ¯”

| å¯¹æ¯”é¡¹ | æ—§æ–¹æ¡ˆï¼ˆå½“å‰ï¼‰ | æ–°æ–¹æ¡ˆï¼ˆæ¨èï¼‰ |
|-------|-------------|--------------|
| **è¯¢ä»·æ–¹å¼** | æ·»åŠ åˆ°è´­ç‰©è½¦ | ç‹¬ç«‹è¯¢ä»·é¡µé¢ |
| **æ•°æ®å­˜å‚¨** | è´­ç‰©è½¦ + Metaobject | ä»… Metaobject |
| **å®¢æœæ“ä½œ** | ä¿®æ”¹ Metaobject | ä¿®æ”¹ Metaobject |
| **å®¢æˆ·æŸ¥çœ‹** | è´­ç‰©è½¦é¡µé¢ | ç‹¬ç«‹è®¢å•é¡µé¢ |
| **ä¸‹å•æ—¶æœº** | è¯¢ä»·æ—¶å·²åœ¨è´­ç‰©è½¦ | ç¡®è®¤æŠ¥ä»·åæ‰åŠ å…¥è´­ç‰©è½¦ |
| **æ˜¯å¦ç¬¦åˆ Shopify è§„åˆ™** | âš ï¸ ç°è‰²åœ°å¸¦ | âœ… å®Œå…¨ç¬¦åˆ |
| **ç”¨æˆ·ä½“éªŒ** | âš ï¸ æ··æ·†ï¼ˆè´­ç‰©è½¦æœ‰æœªæŠ¥ä»·å•†å“ï¼‰ | âœ… æ¸…æ™°ï¼ˆè¯¢ä»·å’Œè®¢å•åˆ†ç¦»ï¼‰ |

---

## ğŸ”„ æ–°æµç¨‹è¯¦è§£

### é˜¶æ®µ 1ï¸âƒ£ï¼šè¯¢ä»·é˜¶æ®µ

#### æ­¥éª¤ 1: å®¢æˆ·æäº¤è¯¢ä»·

**é¡µé¢**: `templates/page.quote-request.liquid`ï¼ˆæ–°å»ºï¼‰

```
å®¢æˆ·æ“ä½œ:
1. ä¸Šä¼  3D æ¨¡å‹æ–‡ä»¶
2. å¡«å†™å‚æ•°ï¼ˆæ•°é‡ã€æè´¨ç­‰ï¼‰
3. ç‚¹å‡»"æäº¤è¯¢ä»·"
```

**æ•°æ®æµ**:
```javascript
å‰ç«¯ (model-uploader.js)
  â†“ POST /api/upload-file
åç«¯ (api/upload-file.js)
  â†“ ä¸Šä¼ æ–‡ä»¶åˆ° Shopify Files
  â†“ åˆ›å»º Metaobject (status: "Pending")
è¿”å› â†’ è¯¢ä»·å•å· (quoteId)
  â†“
å‰ç«¯è·³è½¬ â†’ /pages/my-quotes?id=quoteId
```

**å…³é”®å˜åŒ–**:
- âŒ **ä¸å†**æ·»åŠ åˆ°è´­ç‰©è½¦
- âœ… ç›´æ¥åˆ›å»º Metaobject
- âœ… è·³è½¬åˆ°"æˆ‘çš„è¯¢ä»·"é¡µé¢

---

#### æ­¥éª¤ 2: å®¢æˆ·æŸ¥çœ‹è¯¢ä»·çŠ¶æ€

**é¡µé¢**: `templates/page.my-quotes.liquid`ï¼ˆæ–°å»ºï¼‰

**æ˜¾ç¤ºå†…å®¹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆ‘çš„è¯¢ä»·å•                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯¢ä»·å•å·: Q20250129001              â”‚
â”‚ çŠ¶æ€: ğŸŸ¡ å¾…æŠ¥ä»·                     â”‚
â”‚ æäº¤æ—¶é—´: 2025-01-29 10:30         â”‚
â”‚                                     â”‚
â”‚ æ–‡ä»¶åˆ—è¡¨:                           â”‚
â”‚ â€¢ model.step (667 KB)              â”‚
â”‚                                     â”‚
â”‚ å‚æ•°:                               â”‚
â”‚ â€¢ æ•°é‡: 100                        â”‚
â”‚ â€¢ æè´¨: ABS                        â”‚
â”‚                                     â”‚
â”‚ ğŸ’¬ å®¢æœæ­£åœ¨ä¸ºæ‚¨æŠ¥ä»·ï¼Œè¯·ç¨å€™...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è¯´æ˜**:
- ğŸŸ¡ **å¾…æŠ¥ä»·** (Pending): å®¢æœè¿˜æœªæŠ¥ä»·
- ğŸŸ¢ **å·²æŠ¥ä»·** (Quoted): å®¢æœå·²æŠ¥ä»·ï¼Œå¯ä»¥ä¸‹å•
- ğŸ”´ **å·²æ‹’ç»** (Rejected): æ— æ³•ç”Ÿäº§

---

#### æ­¥éª¤ 3: å®¢æœæ·»åŠ æŠ¥ä»·

**é¡µé¢**: `templates/page.admin-dashboard.liquid`ï¼ˆä¿®æ”¹ï¼‰

**æ“ä½œ**:
```
1. æŸ¥çœ‹å¾…æŠ¥ä»·è®¢å•
2. ç‚¹å‡»"æ·»åŠ æŠ¥ä»·"
3. è¾“å…¥æŠ¥ä»·é‡‘é¢å’Œå¤‡æ³¨
4. ç‚¹å‡»"å‘é€æŠ¥ä»·"
```

**æ•°æ®æµ**:
```javascript
å‰ç«¯ (admin-dashboard)
  â†“ PATCH /api/quotes?handle=quoteId
åç«¯ (api/quotes-restored.js)
  â†“ æ›´æ–° Metaobject:
      status: "Quoted"
      amount: 1500
      note: "æŠ¥ä»·è¯´æ˜"
  â†“
å‰ç«¯ â†’ è°ƒç”¨ /api/send-email
  â†“ å‘é€æŠ¥ä»·é‚®ä»¶ç»™å®¢æˆ·
```

**å…³é”®å˜åŒ–**:
- âœ… ä»ç„¶ä¿®æ”¹ Metaobjectï¼ˆä¸æ¶‰åŠ Shopify è®¢å•ï¼‰
- âœ… å‘é€é‚®ä»¶é€šçŸ¥å®¢æˆ·

---

### é˜¶æ®µ 2ï¸âƒ£ï¼šä¸‹å•é˜¶æ®µ

#### æ­¥éª¤ 4: å®¢æˆ·ç¡®è®¤æŠ¥ä»·

**é¡µé¢**: `templates/page.my-quotes.liquid`

**å®¢æˆ·æ”¶åˆ°æŠ¥ä»·åï¼Œé¡µé¢æ˜¾ç¤º**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯¢ä»·å•å·: Q20250129001              â”‚
â”‚ çŠ¶æ€: ğŸŸ¢ å·²æŠ¥ä»·                     â”‚
â”‚                                     â”‚
â”‚ ğŸ’° æŠ¥ä»·é‡‘é¢: Â¥1,500.00             â”‚
â”‚                                     â”‚
â”‚ ğŸ“ å®¢æœå¤‡æ³¨:                        â”‚
â”‚ æ ¹æ®æ‚¨çš„è¦æ±‚ï¼Œæˆ‘ä»¬æŠ¥ä»·å¦‚ä¸‹...       â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  ğŸ›’ ç«‹å³ä¸‹å•                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚ ç‚¹å‡»"ç«‹å³ä¸‹å•"åå°†åˆ›å»ºæ­£å¼è®¢å•      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### æ­¥éª¤ 5: åˆ›å»ºçœŸå®è®¢å•

**è§¦å‘**: å®¢æˆ·ç‚¹å‡»"ç«‹å³ä¸‹å•"

**æ•°æ®æµ**:
```javascript
å‰ç«¯ (my-quotes.liquid)
  â†“ ç‚¹å‡»"ç«‹å³ä¸‹å•"
  â†“ è°ƒç”¨ createOrder(quoteId)
  â†“
  â†“ æ–¹æ¡ˆ A: ä½¿ç”¨ Ajax API
  â†“ POST /cart/add.js
  â†“ {
  â†“   items: [{
  â†“     id: productVariantId,  // é€šç”¨"å®šåˆ¶äº§å“"çš„å˜ä½“ ID
  â†“     quantity: 1,
  â†“     properties: {
  â†“       _quoteId: "Q20250129001",
  â†“       _amount: "1500",
  â†“       _files: "model.step",
  â†“       _note: "æŠ¥ä»·è¯´æ˜"
  â†“     }
  â†“   }]
  â†“ }
  â†“
  â†“ æ–¹æ¡ˆ B: ä½¿ç”¨ Draft Order API
  â†“ POST /api/create-draft-order
  â†“ åç«¯è°ƒç”¨ Shopify GraphQL
  â†“ draftOrderCreate(...)
  â†“ è¿”å› invoiceUrl
  â†“
è·³è½¬ â†’ /cart æˆ– /checkout
```

**å…³é”®ç‚¹**:
- âœ… **æ­¤æ—¶æ‰åˆ›å»º** Shopify è®¢å•
- âœ… è®¢å•é‡‘é¢ = å®¢æœæŠ¥ä»·çš„é‡‘é¢
- âœ… è®¢å•çŠ¶æ€ = å¾…ä»˜æ¬¾ï¼ˆShopify é»˜è®¤ï¼‰
- âœ… è®¢å•å±æ€§åŒ…å«è¯¢ä»·å•ä¿¡æ¯

---

## ğŸ› ï¸ å®æ–½æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä½¿ç”¨è´­ç‰©è½¦ APIï¼ˆæ¨èï¼Œç®€å•ï¼‰

#### ä¼˜åŠ¿
- âœ… å®æ–½ç®€å•ï¼ˆå‰ç«¯ JavaScript å³å¯ï¼‰
- âœ… æ— éœ€é¢å¤– API æƒé™
- âœ… å®¢æˆ·å¯ä»¥åœ¨è´­ç‰©è½¦ä¿®æ”¹æ•°é‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
- âœ… æ ‡å‡†çš„ Shopify ç»“è´¦æµç¨‹

#### åŠ£åŠ¿
- âš ï¸ éœ€è¦åˆ›å»ºä¸€ä¸ª"é€šç”¨å®šåˆ¶äº§å“"
- âš ï¸ ä»·æ ¼éœ€è¦é€šè¿‡ Line Item Properties ä¼ é€’ï¼ˆæ˜¾ç¤ºå¯èƒ½ä¸å®Œç¾ï¼‰

#### å®æ–½æ­¥éª¤

**1. åˆ›å»ºé€šç”¨äº§å“**

åœ¨ Shopify åå°åˆ›å»ºäº§å“ï¼š
- åç§°: "å®šåˆ¶äº§å“"
- ä»·æ ¼: Â¥0.01ï¼ˆå ä½ä»·æ ¼ï¼‰
- SKU: CUSTOM-QUOTE
- è¯´æ˜: æ­¤äº§å“ç”¨äºå®šåˆ¶è®¢å•ï¼Œå®é™…ä»·æ ¼ä»¥æŠ¥ä»·ä¸ºå‡†

**2. å‰ç«¯ä»£ç **

```javascript
// templates/page.my-quotes.liquid

async function createOrderFromQuote(quote) {
  try {
    // æ·»åŠ åˆ°è´­ç‰©è½¦
    const response = await fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        items: [{
          id: 'YOUR_PRODUCT_VARIANT_ID',  // é€šç”¨å®šåˆ¶äº§å“çš„å˜ä½“ ID
          quantity: 1,
          properties: {
            'è¯¢ä»·å•å·': quote.handle,
            'æŠ¥ä»·é‡‘é¢': `Â¥${quote.amount}`,
            'æ–‡ä»¶': quote.files.map(f => f.fileName).join(', '),
            'å¤‡æ³¨': quote.note || '',
            '_quoteId': quote.handle,  // ä¸‹åˆ’çº¿å¼€å¤´çš„å±æ€§ä¸æ˜¾ç¤ºç»™å®¢æˆ·
            '_metaobjectId': quote.id
          }
        }]
      })
    });

    if (response.ok) {
      // æ›´æ–° Metaobject çŠ¶æ€ä¸º"å·²ä¸‹å•"
      await fetch(`${API_BASE}/quotes?handle=${quote.handle}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: 'Ordered',
          orderedAt: new Date().toISOString()
        })
      });

      // è·³è½¬åˆ°è´­ç‰©è½¦
      window.location.href = '/cart';
    } else {
      alert('æ·»åŠ åˆ°è´­ç‰©è½¦å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  } catch (error) {
    console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
    alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ');
  }
}
```

**3. è´­ç‰©è½¦æ˜¾ç¤º**

è´­ç‰©è½¦ä¼šæ˜¾ç¤ºï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®šåˆ¶äº§å“                            â”‚
â”‚ Â¥0.01                              â”‚
â”‚                                     â”‚
â”‚ è¯¢ä»·å•å·: Q20250129001             â”‚
â”‚ æŠ¥ä»·é‡‘é¢: Â¥1,500.00                â”‚
â”‚ æ–‡ä»¶: model.step                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**: æ˜¾ç¤ºçš„ä»·æ ¼æ˜¯ Â¥0.01ï¼Œä¸æ˜¯æŠ¥ä»·é‡‘é¢

**è§£å†³æ–¹æ¡ˆ**: 
- æ–¹æ¡ˆ 1: åœ¨äº§å“æè¿°ä¸­è¯´æ˜"å®é™…ä»·æ ¼ä»¥æŠ¥ä»·ä¸ºå‡†ï¼Œè¯·è”ç³»å®¢æœä¿®æ”¹"
- æ–¹æ¡ˆ 2: ä½¿ç”¨ Draft Order APIï¼ˆè§æ–¹æ¡ˆ Bï¼‰

---

### æ–¹æ¡ˆ B: ä½¿ç”¨ Draft Order APIï¼ˆæ¨èï¼Œå®Œç¾ï¼‰

#### ä¼˜åŠ¿
- âœ… å¯ä»¥è®¾ç½®ä»»æ„ä»·æ ¼
- âœ… è®¢å•æ˜¾ç¤ºå®Œç¾ï¼ˆä»·æ ¼æ­£ç¡®ï¼‰
- âœ… å®¢æˆ·ä½“éªŒæœ€ä½³
- âœ… æ›´ä¸“ä¸š

#### åŠ£åŠ¿
- âš ï¸ éœ€è¦é¢å¤– API æƒé™ï¼ˆ`write_draft_orders`ï¼‰
- âš ï¸ éœ€è¦åç«¯ API
- âš ï¸ å®æ–½ç¨å¤æ‚

#### å®æ–½æ­¥éª¤

**1. æ·»åŠ  API æƒé™**

åœ¨ Shopify åå°ï¼š
1. è®¾ç½® â†’ åº”ç”¨å’Œé”€å”®æ¸ é“ â†’ å¼€å‘åº”ç”¨
2. é€‰æ‹©ä½ çš„åº”ç”¨
3. é…ç½® Admin API è®¿é—®èŒƒå›´
4. æ·»åŠ æƒé™ï¼š
   - âœ… `write_draft_orders`ï¼ˆåˆ›å»ºè‰ç¨¿è®¢å•ï¼‰
   - âœ… `read_draft_orders`ï¼ˆè¯»å–è‰ç¨¿è®¢å•ï¼‰
5. ä¿å­˜å¹¶é‡æ–°å®‰è£…åº”ç”¨

**2. åˆ›å»ºåç«¯ API**

```javascript
// api/create-draft-order.js

/**
 * ä»è¯¢ä»·å•åˆ›å»º Shopify è‰ç¨¿è®¢å•
 * 
 * è‰ç¨¿è®¢å• = å®¢æœåˆ›å»ºçš„è®¢å•ï¼Œå‘é€ç»™å®¢æˆ·ç¡®è®¤å’Œä»˜æ¬¾
 * ä¼˜åŠ¿ï¼šå¯ä»¥è®¾ç½®ä»»æ„ä»·æ ¼ï¼Œä¸å—äº§å“ä»·æ ¼é™åˆ¶
 */

async function shopGql(query, variables) {
  const storeDomain = process.env.SHOPIFY_STORE_DOMAIN;
  const accessToken = process.env.SHOPIFY_ACCESS_TOKEN;
  
  const endpoint = `https://${storeDomain}/admin/api/2024-07/graphql.json`;
  const resp = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Shopify-Access-Token': accessToken,
    },
    body: JSON.stringify({ query, variables }),
  });
  
  return await resp.json();
}

export default async function handler(req, res) {
  // CORS
  res.setHeader('Access-Control-Allow-Origin', 'https://sain-pdc-test.myshopify.com');
  res.setHeader('Access-Control-Allow-Methods', 'POST,OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    return res.status(204).end();
  }
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }
  
  const { quoteId, customerEmail, amount, files, note } = req.body;
  
  try {
    // 1. æŸ¥æ‰¾æˆ–åˆ›å»ºå®¢æˆ·
    const customerQuery = `
      query($email: String!) {
        customers(first: 1, query: $email) {
          edges {
            node {
              id
              email
            }
          }
        }
      }
    `;
    
    const customerResult = await shopGql(customerQuery, {
      email: `email:${customerEmail}`
    });
    
    let customerId = null;
    if (customerResult.data.customers.edges.length > 0) {
      customerId = customerResult.data.customers.edges[0].node.id;
    }
    
    // 2. åˆ›å»ºè‰ç¨¿è®¢å•
    const draftOrderMutation = `
      mutation($input: DraftOrderInput!) {
        draftOrderCreate(input: $input) {
          draftOrder {
            id
            invoiceUrl
            name
          }
          userErrors {
            field
            message
          }
        }
      }
    `;
    
    const lineItems = [{
      title: `å®šåˆ¶äº§å“ - ${quoteId}`,
      quantity: 1,
      originalUnitPrice: amount,
      customAttributes: [
        { key: "è¯¢ä»·å•å·", value: quoteId },
        { key: "æ–‡ä»¶", value: files.map(f => f.fileName).join(', ') },
        { key: "å¤‡æ³¨", value: note || '' }
      ]
    }];
    
    const draftOrderInput = {
      lineItems: lineItems,
      email: customerEmail,
      note: `è¯¢ä»·å•: ${quoteId}`,
      tags: ['quote', quoteId]
    };
    
    if (customerId) {
      draftOrderInput.customerId = customerId;
    }
    
    const draftOrderResult = await shopGql(draftOrderMutation, {
      input: draftOrderInput
    });
    
    if (draftOrderResult.data.draftOrderCreate.userErrors.length > 0) {
      console.error('åˆ›å»ºè‰ç¨¿è®¢å•å¤±è´¥:', draftOrderResult.data.draftOrderCreate.userErrors);
      return res.status(400).json({
        error: 'åˆ›å»ºè®¢å•å¤±è´¥',
        details: draftOrderResult.data.draftOrderCreate.userErrors
      });
    }
    
    const draftOrder = draftOrderResult.data.draftOrderCreate.draftOrder;
    
    // 3. è¿”å›ç»“æœ
    return res.json({
      success: true,
      draftOrderId: draftOrder.id,
      draftOrderName: draftOrder.name,
      invoiceUrl: draftOrder.invoiceUrl,  // å®¢æˆ·ä»˜æ¬¾é“¾æ¥
      message: 'è®¢å•åˆ›å»ºæˆåŠŸ'
    });
    
  } catch (error) {
    console.error('åˆ›å»ºè‰ç¨¿è®¢å•å¤±è´¥:', error);
    return res.status(500).json({
      error: 'æœåŠ¡å™¨é”™è¯¯',
      message: error.message
    });
  }
}
```

**3. å‰ç«¯ä»£ç **

```javascript
// templates/page.my-quotes.liquid

async function createOrderFromQuote(quote) {
  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const btn = document.getElementById('order-btn');
    btn.disabled = true;
    btn.textContent = 'åˆ›å»ºè®¢å•ä¸­...';
    
    // è°ƒç”¨åç«¯ API åˆ›å»ºè‰ç¨¿è®¢å•
    const response = await fetch(`${API_BASE}/create-draft-order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        quoteId: quote.handle,
        customerEmail: quote.email,
        amount: quote.amount,
        files: quote.files,
        note: quote.note
      })
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      // æ›´æ–° Metaobject çŠ¶æ€
      await fetch(`${API_BASE}/quotes?handle=${quote.handle}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: 'Ordered',
          draftOrderId: result.draftOrderId,
          orderedAt: new Date().toISOString()
        })
      });
      
      // è·³è½¬åˆ°ä»˜æ¬¾é¡µé¢
      window.location.href = result.invoiceUrl;
    } else {
      alert('åˆ›å»ºè®¢å•å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
      btn.disabled = false;
      btn.textContent = 'ğŸ›’ ç«‹å³ä¸‹å•';
    }
    
  } catch (error) {
    console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
    alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ');
    btn.disabled = false;
    btn.textContent = 'ğŸ›’ ç«‹å³ä¸‹å•';
  }
}
```

**4. å®¢æˆ·ä½“éªŒ**

```
å®¢æˆ·ç‚¹å‡»"ç«‹å³ä¸‹å•"
  â†“
æ˜¾ç¤º"åˆ›å»ºè®¢å•ä¸­..."
  â†“
åç«¯åˆ›å»ºè‰ç¨¿è®¢å•
  â†“
è·³è½¬åˆ° Shopify ä»˜æ¬¾é¡µé¢
  â†“
è®¢å•æ˜¾ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å• #D1001                         â”‚
â”‚                                     â”‚
â”‚ å®šåˆ¶äº§å“ - Q20250129001            â”‚
â”‚ æ•°é‡: 1                            â”‚
â”‚ å•ä»·: Â¥1,500.00                    â”‚
â”‚ å°è®¡: Â¥1,500.00                    â”‚
â”‚                                     â”‚
â”‚ æ€»è®¡: Â¥1,500.00                    â”‚
â”‚                                     â”‚
â”‚ [ç»§ç»­ä»˜æ¬¾]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**:
- âœ… ä»·æ ¼å®Œå…¨æ­£ç¡®ï¼ˆÂ¥1,500.00ï¼‰
- âœ… æ˜¾ç¤ºå®Œç¾
- âœ… æ ‡å‡†çš„ Shopify ç»“è´¦æµç¨‹

---

### æ–¹æ¡ˆ C: æ··åˆæ–¹æ¡ˆï¼ˆå¹³è¡¡ï¼‰

**æ€è·¯**: 
- å°é¢è®¢å•ï¼ˆ< Â¥500ï¼‰: ä½¿ç”¨è´­ç‰©è½¦ APIï¼ˆæ–¹æ¡ˆ Aï¼‰
- å¤§é¢è®¢å•ï¼ˆâ‰¥ Â¥500ï¼‰: ä½¿ç”¨ Draft Order APIï¼ˆæ–¹æ¡ˆ Bï¼‰

**ä¼˜åŠ¿**:
- âœ… çµæ´»
- âœ… å°è®¢å•å¿«é€Ÿå¤„ç†
- âœ… å¤§è®¢å•ä½“éªŒæ›´å¥½

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| å¯¹æ¯”é¡¹ | æ–¹æ¡ˆ A: è´­ç‰©è½¦ API | æ–¹æ¡ˆ B: Draft Order API | æ–¹æ¡ˆ C: æ··åˆ |
|-------|------------------|----------------------|------------|
| **å®æ–½éš¾åº¦** | â­ ç®€å• | â­â­â­ ä¸­ç­‰ | â­â­â­â­ å¤æ‚ |
| **ä»·æ ¼æ˜¾ç¤º** | âš ï¸ ä¸å‡†ç¡®ï¼ˆÂ¥0.01ï¼‰ | âœ… å®Œç¾ï¼ˆæŠ¥ä»·é‡‘é¢ï¼‰ | âœ… éƒ¨åˆ†å®Œç¾ |
| **API æƒé™** | âœ… æ— éœ€é¢å¤–æƒé™ | âš ï¸ éœ€è¦ `write_draft_orders` | âš ï¸ éœ€è¦æƒé™ |
| **ç”¨æˆ·ä½“éªŒ** | â­â­â­ è‰¯å¥½ | â­â­â­â­â­ å®Œç¾ | â­â­â­â­ å¾ˆå¥½ |
| **å¼€å‘æ—¶é—´** | 1-2 å°æ—¶ | 3-4 å°æ—¶ | 4-5 å°æ—¶ |
| **æ¨èåº¦** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |

---

## ğŸ¯ æ¨èå®æ–½é¡ºåº

### é˜¶æ®µ 1: åŸºç¡€åŠŸèƒ½ï¼ˆ1-2 å¤©ï¼‰

1. âœ… ä¿®æ”¹å‰ç«¯ï¼šç§»é™¤è´­ç‰©è½¦é€»è¾‘
2. âœ… åˆ›å»º"æˆ‘çš„è¯¢ä»·"é¡µé¢
3. âœ… ä½¿ç”¨æ–¹æ¡ˆ Aï¼ˆè´­ç‰©è½¦ APIï¼‰å®ç°ä¸‹å•
4. âœ… æµ‹è¯•å®Œæ•´æµç¨‹

### é˜¶æ®µ 2: ä¼˜åŒ–ä½“éªŒï¼ˆ2-3 å¤©ï¼‰

1. âœ… æ·»åŠ  `write_draft_orders` æƒé™
2. âœ… å®ç°æ–¹æ¡ˆ Bï¼ˆDraft Order APIï¼‰
3. âœ… æ›¿æ¢æ–¹æ¡ˆ A
4. âœ… æµ‹è¯•å¹¶ä¸Šçº¿

### é˜¶æ®µ 3: é«˜çº§åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

1. âœ… æ·»åŠ è®¢å•çŠ¶æ€è¿½è¸ª
2. âœ… æ·»åŠ è®¢å•å†å²è®°å½•
3. âœ… æ·»åŠ è®¢å•æœç´¢åŠŸèƒ½

---

## ğŸ“ éœ€è¦åˆ›å»ºçš„æ–‡ä»¶

### æ–°å»ºæ–‡ä»¶

1. **templates/page.quote-request.liquid** - è¯¢ä»·æäº¤é¡µé¢
2. **templates/page.my-quotes.liquid** - æˆ‘çš„è¯¢ä»·é¡µé¢
3. **api/create-draft-order.js** - åˆ›å»ºè‰ç¨¿è®¢å• APIï¼ˆæ–¹æ¡ˆ Bï¼‰

### ä¿®æ”¹æ–‡ä»¶

1. **assets/model-uploader.js** - ç§»é™¤è´­ç‰©è½¦é€»è¾‘
2. **templates/page.admin-dashboard.liquid** - ä¿æŒä¸å˜ï¼ˆæˆ–å°æ”¹ï¼‰
3. **api/quotes-restored.js** - æ·»åŠ æ–°çŠ¶æ€ï¼ˆOrderedï¼‰

### åˆ é™¤æ–‡ä»¶

1. **templates/cart.quote.liquid** - ä¸å†éœ€è¦ï¼ˆä¸ä½¿ç”¨è´­ç‰©è½¦ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥

ä½ æƒ³è¦ï¼š

**é€‰é¡¹ A**: æˆ‘å¸®ä½ å®ç°æ–¹æ¡ˆ Aï¼ˆè´­ç‰©è½¦ APIï¼Œå¿«é€Ÿä¸Šçº¿ï¼‰  
**é€‰é¡¹ B**: æˆ‘å¸®ä½ å®ç°æ–¹æ¡ˆ Bï¼ˆDraft Order APIï¼Œå®Œç¾ä½“éªŒï¼‰  
**é€‰é¡¹ C**: å…ˆçœ‹çœ‹è¯¦ç»†çš„ä»£ç ç¤ºä¾‹å†å†³å®š

è¯·å‘Šè¯‰æˆ‘ä½ çš„é€‰æ‹©ï¼ ğŸ¯

