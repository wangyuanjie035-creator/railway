# ğŸ“§ é‚®ä»¶å‘é€å’Œè®¢å•çŠ¶æ€åŒæ­¥åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ å®ç°ç›®æ ‡

1. **åœ¨ç®¡ç†ç«¯æ·»åŠ å‘é€é‚®ä»¶æŒ‰é’®ï¼Œä¸Shopifyå†…ç½®çš„"å‘é€å‘ç¥¨"åŠŸèƒ½è€¦åˆ**
2. **åœ¨æˆ‘çš„è¯¢ä»·é¡µé¢æ˜¾ç¤ºå®Œæ•´çš„è®¢å•çŠ¶æ€ï¼ˆå·²ä»˜æ¬¾ã€å·²å‘è´§ç­‰ï¼‰**
3. **å®ç°ä¸Shopifyè®¢å•çŠ¶æ€çš„å®æ—¶åŒæ­¥**

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### 1. å‘é€é‚®ä»¶åŠŸèƒ½
- åœ¨ç®¡ç†ç«¯å·²æŠ¥ä»·çš„è®¢å•æ—æ·»åŠ "ğŸ“§ å‘é€é‚®ä»¶"æŒ‰é’®
- è°ƒç”¨Shopifyå†…ç½®çš„å‘é€å‘ç¥¨åŠŸèƒ½
- å‘é€åŒ…å«ç»“è´¦é“¾æ¥å’Œè®¢å•è¯¦æƒ…çš„é‚®ä»¶ç»™å®¢æˆ·
- æ”¯æŒè‡ªå®šä¹‰é‚®ä»¶å†…å®¹

### 2. è®¢å•çŠ¶æ€æ˜¾ç¤º
- æ‰©å±•è®¢å•çŠ¶æ€æ”¯æŒï¼šå¾…æŠ¥ä»·ã€å·²æŠ¥ä»·ã€å¾…ä»˜æ¬¾ã€å·²ä»˜æ¬¾ã€å·²å‘è´§ã€å·²å®Œæˆã€å·²å–æ¶ˆ
- å®æ—¶åŒæ­¥Shopifyè®¢å•çŠ¶æ€
- æ˜¾ç¤ºä»˜æ¬¾æ—¶é—´ã€å‘è´§æ—¶é—´ç­‰è¯¦ç»†ä¿¡æ¯
- æ”¯æŒç‰©æµè·Ÿè¸ªä¿¡æ¯æ˜¾ç¤º

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. å‘é€é‚®ä»¶API

**æ–‡ä»¶**: `api/send-invoice-email.js`

**æ ¸å¿ƒåŠŸèƒ½**:
```javascript
// è°ƒç”¨Shopifyçš„draftOrderInvoiceSend mutation
const sendInvoiceMutation = `
  mutation draftOrderInvoiceSend($id: ID!, $input: DraftOrderInvoiceSendInput!) {
    draftOrderInvoiceSend(id: $id, input: $input) {
      draftOrder {
        id
        name
        invoiceUrl
      }
      userErrors {
        field
        message
      }
    }
  }
`;
```

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
POST /api/send-invoice-email
{
  "draftOrderId": "gid://shopify/DraftOrder/123456789",
  "customMessage": "æ‚¨çš„3Dæ‰“å°æŠ¥ä»·å·²å®Œæˆï¼Œè¯·ç‚¹å‡»é“¾æ¥æŸ¥çœ‹è¯¦æƒ…å¹¶ä»˜æ¬¾ã€‚"
}
```

### 2. è®¢å•çŠ¶æ€API

**æ–‡ä»¶**: `api/get-order-status.js`

**æ”¯æŒçš„è®¢å•çŠ¶æ€**:
- `pending` - å¾…æŠ¥ä»·
- `quoted` - å·²æŠ¥ä»·
- `pending_payment` - å¾…ä»˜æ¬¾
- `paid` - å·²ä»˜æ¬¾
- `fulfilled` - å·²å‘è´§
- `completed` - å·²å®Œæˆ
- `cancelled` - å·²å–æ¶ˆ

**æ ¸å¿ƒåŠŸèƒ½**:
```javascript
// æŸ¥è¯¢è‰ç¨¿è®¢å•å’Œæ­£å¼è®¢å•çŠ¶æ€
const getDraftOrderQuery = `...`;
const getOrderQuery = `...`;

// çŠ¶æ€åˆ¤æ–­é€»è¾‘
if (isCompleted && orderInfo) {
  const financialStatus = orderInfo.financialStatus;
  const fulfillmentStatus = orderInfo.fulfillmentStatus;
  
  if (financialStatus === 'PAID') {
    status = 'å·²ä»˜æ¬¾';
    if (fulfillmentStatus === 'FULFILLED') {
      status = 'å·²å‘è´§';
    }
  }
}
```

### 3. ç®¡ç†ç«¯ç•Œé¢æ›´æ–°

**æ–‡ä»¶**: `templates/page.admin-draft-orders.liquid`

**æ–°å¢åŠŸèƒ½**:
```javascript
// å‘é€é‚®ä»¶æŒ‰é’®ï¼ˆä»…åœ¨å·²æŠ¥ä»·è®¢å•æ˜¾ç¤ºï¼‰
<button class="action-btn email" onclick="sendInvoiceEmail('${order.id}', '${order.email}', '${order.name}')" title="å‘é€å‘ç¥¨é‚®ä»¶">
  ğŸ“§ å‘é€é‚®ä»¶
</button>

// å‘é€é‚®ä»¶å‡½æ•°
async function sendInvoiceEmail(orderId, customerEmail, orderName) {
  const response = await fetch(`${API_BASE}/send-invoice-email`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      draftOrderId: orderId,
      customMessage: `æ‚¨çš„3Dæ‰“å°æŠ¥ä»·å·²å®Œæˆï¼\n\nè®¢å•å·: ${orderName}\nè¯·ç‚¹å‡»ä¸‹æ–¹çš„ç»“è´¦é“¾æ¥æŸ¥çœ‹è¯¦æƒ…å¹¶å®Œæˆä»˜æ¬¾ã€‚`
    })
  });
}
```

### 4. æˆ‘çš„è¯¢ä»·é¡µé¢æ›´æ–°

**æ–‡ä»¶**: `templates/page.my-quotes.liquid`

**çŠ¶æ€æ˜¾ç¤ºå¢å¼º**:
```javascript
// æ‰©å±•çŠ¶æ€æ˜ å°„
const statusMap = {
  'pending': { text: 'å¾…æŠ¥ä»·', className: 'status-pending' },
  'quoted': { text: 'å·²æŠ¥ä»·', className: 'status-quoted' },
  'pending_payment': { text: 'å¾…ä»˜æ¬¾', className: 'status-pending-payment' },
  'paid': { text: 'å·²ä»˜æ¬¾', className: 'status-paid' },
  'fulfilled': { text: 'å·²å‘è´§', className: 'status-fulfilled' },
  'completed': { text: 'å·²å®Œæˆ', className: 'status-completed' },
  'cancelled': { text: 'å·²å–æ¶ˆ', className: 'status-cancelled' }
};

// åŠ è½½æ‰©å±•çŠ¶æ€ä¿¡æ¯
async function loadExtendedOrderStatus(order) {
  const response = await fetch(`${API_BASE}/get-order-status?draftOrderId=${encodeURIComponent(order.id)}`);
  const statusData = await response.json();
  
  order.extendedStatus = {
    status: statusData.status,
    statusCode: statusData.statusCode,
    paidAt: statusData.paidAt,
    fulfilledAt: statusData.fulfilledAt,
    fulfillments: statusData.fulfillments,
    isCompleted: statusData.isCompleted,
    orderInfo: statusData.orderInfo
  };
}
```

## ğŸ¨ ç•Œé¢ä¼˜åŒ–

### 1. å‘é€é‚®ä»¶æŒ‰é’®æ ·å¼
```css
.action-btn.email {
  background: #27ae60;
  color: white;
  font-size: 12px;
  padding: 8px 12px;
}

.action-btn.email:hover {
  background: #219a52;
}
```

### 2. è®¢å•çŠ¶æ€æ ·å¼
```css
.status-pending-payment {
  background: #fff3cd;
  color: #856404;
}

.status-paid {
  background: #d1ecf1;
  color: #0c5460;
}

.status-fulfilled {
  background: #d4edda;
  color: #155724;
}

.status-completed {
  background: #e2e3e5;
  color: #383d41;
}

.status-cancelled {
  background: #f8d7da;
  color: #721c24;
}
```

## ğŸ“Š åŠŸèƒ½æµç¨‹

### 1. å‘é€é‚®ä»¶æµç¨‹
```
ç®¡ç†å‘˜ç‚¹å‡»"å‘é€é‚®ä»¶"æŒ‰é’®
    â†“
ç¡®è®¤å‘é€å¯¹è¯æ¡†
    â†“
è°ƒç”¨ send-invoice-email API
    â†“
è°ƒç”¨Shopify draftOrderInvoiceSend mutation
    â†“
å‘é€åŒ…å«ç»“è´¦é“¾æ¥çš„é‚®ä»¶ç»™å®¢æˆ·
    â†“
æ˜¾ç¤ºå‘é€æˆåŠŸç¡®è®¤
```

### 2. è®¢å•çŠ¶æ€åŒæ­¥æµç¨‹
```
å®¢æˆ·è®¿é—®æˆ‘çš„è¯¢ä»·é¡µé¢
    â†“
åŠ è½½è®¢å•åŸºæœ¬ä¿¡æ¯
    â†“
è°ƒç”¨ get-order-status API
    â†“
æŸ¥è¯¢è‰ç¨¿è®¢å•å’Œæ­£å¼è®¢å•çŠ¶æ€
    â†“
åˆ¤æ–­è®¢å•å½“å‰çŠ¶æ€
    â†“
æ›´æ–°é¡µé¢æ˜¾ç¤ºçŠ¶æ€
    â†“
å®šæ—¶åˆ·æ–°çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
```

## âœ… å®ç°çš„åŠŸèƒ½

### 1. é‚®ä»¶å‘é€åŠŸèƒ½
- âœ… ç®¡ç†ç«¯å‘é€é‚®ä»¶æŒ‰é’®
- âœ… ä¸Shopifyå‘é€å‘ç¥¨åŠŸèƒ½è€¦åˆ
- âœ… è‡ªå®šä¹‰é‚®ä»¶å†…å®¹
- âœ… å‘é€ç¡®è®¤å’Œé”™è¯¯å¤„ç†

### 2. è®¢å•çŠ¶æ€æ˜¾ç¤º
- âœ… 7ç§è®¢å•çŠ¶æ€æ”¯æŒ
- âœ… å®æ—¶çŠ¶æ€åŒæ­¥
- âœ… ä»˜æ¬¾å’Œå‘è´§æ—¶é—´æ˜¾ç¤º
- âœ… ç‰©æµè·Ÿè¸ªä¿¡æ¯æ”¯æŒ

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- âœ… ç›´è§‚çš„çŠ¶æ€é¢œè‰²åŒºåˆ†
- âœ… è¯¦ç»†çš„ç¡®è®¤å¯¹è¯æ¡†
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
- âœ… è‡ªåŠ¨çŠ¶æ€åˆ·æ–°

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. é‚®ä»¶å‘é€æµ‹è¯•
- ç®¡ç†å‘˜ç‚¹å‡»å‘é€é‚®ä»¶æŒ‰é’®
- ç¡®è®¤å‘é€å¯¹è¯æ¡†æ˜¾ç¤ºæ­£ç¡®
- é‚®ä»¶æˆåŠŸå‘é€åˆ°å®¢æˆ·é‚®ç®±
- é‚®ä»¶åŒ…å«æ­£ç¡®çš„ç»“è´¦é“¾æ¥

### 2. è®¢å•çŠ¶æ€æµ‹è¯•
- è‰ç¨¿è®¢å•çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
- ä»˜æ¬¾åçŠ¶æ€è‡ªåŠ¨æ›´æ–°
- å‘è´§åçŠ¶æ€è‡ªåŠ¨æ›´æ–°
- é¡µé¢å®šæ—¶åˆ·æ–°åŠŸèƒ½æ­£å¸¸

### 3. ç•Œé¢æµ‹è¯•
- æŒ‰é’®æ ·å¼æ˜¾ç¤ºæ­£ç¡®
- çŠ¶æ€é¢œè‰²åŒºåˆ†æ˜æ˜¾
- å“åº”å¼å¸ƒå±€æ­£å¸¸
- é”™è¯¯æç¤ºæ¸…æ™°

## ğŸ“ˆ ç³»ç»Ÿä¼˜åŠ¿

### 1. é›†æˆåº¦é«˜
- å®Œå…¨é›†æˆShopifyå†…ç½®åŠŸèƒ½
- æ— éœ€é¢å¤–çš„é‚®ä»¶æœåŠ¡é…ç½®
- åˆ©ç”¨Shopifyçš„é‚®ä»¶æ¨¡æ¿ç³»ç»Ÿ

### 2. å®æ—¶æ€§å¼º
- è®¢å•çŠ¶æ€å®æ—¶åŒæ­¥
- è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- çŠ¶æ€å˜åŒ–åŠæ—¶é€šçŸ¥

### 3. ç”¨æˆ·ä½“éªŒå¥½
- ç›´è§‚çš„æ“ä½œç•Œé¢
- æ¸…æ™°çš„çŠ¶æ€æ˜¾ç¤º
- å®Œå–„çš„åé¦ˆæœºåˆ¶

### 4. æ‰©å±•æ€§å¼º
- æ”¯æŒæ›´å¤šè®¢å•çŠ¶æ€
- å¯æ‰©å±•ç‰©æµè·Ÿè¸ªåŠŸèƒ½
- æ”¯æŒè‡ªå®šä¹‰é‚®ä»¶æ¨¡æ¿

## ğŸš€ éƒ¨ç½²è¯´æ˜

### ä¿®æ”¹çš„æ–‡ä»¶
- `api/send-invoice-email.js` - æ–°å¢é‚®ä»¶å‘é€API
- `api/get-order-status.js` - æ–°å¢è®¢å•çŠ¶æ€API
- `templates/page.admin-draft-orders.liquid` - æ·»åŠ å‘é€é‚®ä»¶æŒ‰é’®
- `templates/page.my-quotes.liquid` - å¢å¼ºçŠ¶æ€æ˜¾ç¤ºåŠŸèƒ½

### éƒ¨ç½²æ­¥éª¤
1. ä¸Šä¼ æ–°å¢çš„APIæ–‡ä»¶
2. æ›´æ–°ç®¡ç†ç«¯å’Œå®¢æˆ·ç«¯çš„æ¨¡æ¿æ–‡ä»¶
3. æµ‹è¯•é‚®ä»¶å‘é€åŠŸèƒ½
4. éªŒè¯è®¢å•çŠ¶æ€åŒæ­¥åŠŸèƒ½
5. æ£€æŸ¥ç•Œé¢æ˜¾ç¤ºæ•ˆæœ

---

**å®ç°å®Œæˆæ—¶é—´**: 2025å¹´1æœˆ29æ—¥  
**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ  
**é‚®ä»¶å‘é€åŠŸèƒ½**: âœ… ä¸Shopifyé›†æˆ  
**è®¢å•çŠ¶æ€åŒæ­¥**: âœ… å®æ—¶åŒæ­¥  
**ç”¨æˆ·ä½“éªŒ**: âœ… æ˜¾è‘—æå‡
