# 文件存储位置说明

## 📍 根据日志判断

从你的日志可以看到：
```
🔄 跳过Shopify Files上传，直接使用Base64存储
文件已存储到服务端: file_1763691759690_xb4i5vt2t
当前存储数量: 1
```

**答案**：文件存储在 **Railway 服务器内存**中，**不是** Shopify 服务器。

---

## 🔍 两种存储方式对比

### 方式 1: Shopify Files（当 `SKIP_SHOPIFY_FILES=false`）

**存储位置**：Shopify 管理的 Google Cloud Storage 存储桶

**流程**：
```
客户端上传文件
  ↓
Railway 服务器接收
  ↓
调用 Shopify Staged Upload API（获取上传参数）
  ↓
上传到 Google Cloud Storage（Shopify 管理的存储桶）
  ↓
创建 Shopify Files 记录
  ↓
文件存储在 Shopify 服务器（Google Cloud Storage）
```

**日志显示**：
```
✅ 文件上传到Shopify Files成功
Shopify文件ID: gid://shopify/File/123456
文件存储方式: Shopify Files
```

### 方式 2: Railway 内存存储（当 `SKIP_SHOPIFY_FILES=true`，当前使用）

**存储位置**：Railway 服务器内存（`global.fileStorage` Map）

**流程**：
```
客户端上传文件
  ↓
Railway 服务器接收
  ↓
跳过 Shopify Files 上传
  ↓
调用 /api/store-file-data
  ↓
存储到 global.fileStorage（Railway 服务器内存）
  ↓
文件存储在 Railway 服务器内存
```

**日志显示**（你的情况）：
```
🔄 跳过Shopify Files上传，直接使用Base64存储
文件已存储到服务端: file_1763691759690_xb4i5vt2t
当前存储数量: 1
```

---

## 🔍 代码确认

### 当前情况（SKIP_SHOPIFY_FILES=true）

```javascript
// api/submit-quote-real.js
if (process.env.SKIP_SHOPIFY_FILES === 'true') {
  console.log('🔄 跳过Shopify Files上传，直接使用Base64存储');
  // 不调用 Shopify Files API
}

// 后续调用 store-file-data
const storeResponse = await fetch(`${baseUrl}/api/store-file-data`, {
  method: 'POST',
  body: JSON.stringify({
    draftOrderId: draftOrder.id,
    fileData: req.body.fileUrl.split(',')[1],  // Base64 数据
    fileName: fileName
  })
});
```

```javascript
// api/store-file-data.js
// 存储到 Railway 服务器内存
if (!global.fileStorage) {
  global.fileStorage = new Map();
}

global.fileStorage.set(fileId, {
  draftOrderId,
  fileName,
  fileData,  // Base64 数据存储在内存中
  uploadTime: new Date().toISOString()
});
```

---

## 📊 存储位置对比

| 项目 | Shopify Files | Railway 内存存储 |
|------|--------------|----------------|
| **存储位置** | Shopify 服务器（Google Cloud Storage） | Railway 服务器内存 |
| **持久性** | ✅ 永久存储 | ❌ 服务器重启后丢失 |
| **访问方式** | Shopify CDN URL | Railway API (`/api/download-file`) |
| **文件大小限制** | 100MB | 受服务器内存限制 |
| **成本** | Shopify 管理 | Railway 内存占用 |

---

## ⚠️ 当前情况说明

### 你的日志显示

```
🔄 跳过Shopify Files上传，直接使用Base64存储
文件已存储到服务端: file_1763691759690_xb4i5vt2t
```

**这意味着**：
1. ✅ `SKIP_SHOPIFY_FILES=true`（环境变量已设置）
2. ✅ 文件存储在 **Railway 服务器内存**中
3. ❌ 文件**没有**上传到 Shopify 服务器

### 为什么使用 Railway 内存存储？

**原因**：
- Shopify Files 上传遇到 403 错误（签名验证失败）
- 使用 Railway 内存存储作为**临时备用方案**
- 确保功能可用，但文件会在服务器重启后丢失

### 文件存储在哪里？

**答案**：**Railway 服务器内存**（`global.fileStorage` Map）

**不是**：
- ❌ Shopify 服务器
- ❌ Google Cloud Storage
- ❌ Shopify Files

**是**：
- ✅ Railway 服务器内存（临时存储）

---

## 🔄 如何切换到 Shopify Files？

### 如果想使用 Shopify Files 存储

1. **修改环境变量**：
   ```env
   SKIP_SHOPIFY_FILES=false  # 或删除此变量
   ```

2. **重新部署 Railway**

3. **测试上传**：
   - 如果成功：文件会存储在 Shopify 服务器
   - 如果失败（403错误）：会回退到 Railway 内存存储

### 查看存储位置

在 Draft Order 的 `customAttributes` 中查看：

```json
{
  "文件存储方式": "Base64",  // 当前：Railway 内存存储
  "文件数据位置": "Server Local Storage",  // Railway 服务器
  "Shopify文件ID": "未上传"  // 没有上传到 Shopify
}
```

如果使用 Shopify Files：
```json
{
  "文件存储方式": "Shopify Files",  // Shopify 服务器
  "文件数据位置": "Shopify Files",  // Shopify 服务器
  "Shopify文件ID": "gid://shopify/File/123456"  // Shopify 文件 ID
}
```

---

## ✅ 总结

### 当前情况

**问题**：为什么 Shopify Files 失败了，此时是上传到 Shopify 的服务器还是 Railway 内存存储？

**答案**：
- ❌ **不是**上传到 Shopify 服务器
- ✅ **是**存储在 Railway 服务器内存中

**原因**：
- `SKIP_SHOPIFY_FILES=true` 环境变量已设置
- 系统跳过了 Shopify Files 上传
- 文件存储在 Railway 服务器内存（`global.fileStorage`）

**影响**：
- ✅ 功能可用（可以上传和下载）
- ⚠️ 文件会在服务器重启后丢失
- ⚠️ 这是临时备用方案，不是理想方案

### 理想情况

- ✅ 修复 Shopify Files 上传的 403 错误
- ✅ 设置 `SKIP_SHOPIFY_FILES=false`
- ✅ 文件永久存储在 Shopify 服务器（Google Cloud Storage）

