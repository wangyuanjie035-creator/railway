# Railway 部署问题排查指南

## 常见部署错误和解决方案

### 1. Dockerfile 不存在错误 ✅ 已解决

**错误信息**:
```
Dockerfile `Dockerfile` does not exist
```

**解决方案**: 已创建 `Dockerfile` 文件

---

### 2. 依赖安装失败

**错误信息**:
```
npm ERR! code ENOENT
npm ERR! syscall open
npm ERR! path /app/package-lock.json
```

**解决方案**: 
- Dockerfile 已优化，会自动检测 package-lock.json 是否存在
- 如果存在，使用 `npm ci`（更快）
- 如果不存在，使用 `npm install`

---

### 3. 端口监听错误

**错误信息**:
```
Error: listen EADDRINUSE: address already in use :::8080
```

**解决方案**:
- ✅ 已配置：服务器使用 `process.env.PORT` 或默认 8080
- ✅ 已配置：服务器监听 `0.0.0.0`（所有网络接口）
- Railway 会自动设置 `PORT` 环境变量

---

### 4. 环境变量未设置

**错误信息**:
```
缺少 Shopify 配置
Missing environment variables: SHOP or ADMIN_TOKEN
```

**解决方案**:
在 Railway 项目设置中配置以下环境变量：
- `SHOPIFY_STORE_DOMAIN` 或 `SHOP`
- `SHOPIFY_ACCESS_TOKEN` 或 `ADMIN_TOKEN`
- `PUBLIC_BASE_URL`（可选，用于文件上传回调）

---

### 5. 内存不足

**错误信息**:
```
FATAL ERROR: Reached heap limit Allocation failed
```

**解决方案**:
- 增加 Railway 服务的内存限制
- 或优化代码，减少内存使用

---

### 6. 启动命令错误

**错误信息**:
```
npm ERR! missing script: start
```

**解决方案**:
- ✅ 已配置：`package.json` 中有 `"start": "node server.js"`
- ✅ 已配置：`railway.json` 中有 `"startCommand": "npm start"`

---

### 7. 健康检查失败

**错误信息**:
```
Health check failed
```

**解决方案**:
- ✅ 已配置：健康检查路径为 `/health`
- ✅ 已配置：服务器有 `/health` 和 `/api/health` 端点
- 检查服务器是否正常启动

---

### 8. 文件上传失败（Shopify Files）

**错误信息**:
```
403 Forbidden: SignatureDoesNotMatch
```

**解决方案**:
1. 检查环境变量 `SKIP_SHOPIFY_FILES`
   - 如果设置为 `true`，将跳过 Shopify Files，使用本地存储
   - 如果要使用 Shopify Files，不要设置此变量或设置为 `false`

2. 检查 FormData 构建
   - 确保参数顺序正确
   - 确保文件是最后一个字段

3. 查看详细日志
   - 检查 Railway 日志中的详细错误信息

---

## 诊断步骤

### 步骤 1: 检查部署日志

在 Railway 项目页面：
1. 打开 "Deployments" 标签
2. 查看最新的部署日志
3. 找到错误信息

### 步骤 2: 检查环境变量

在 Railway 项目设置中：
1. 打开 "Variables" 标签
2. 确认以下变量已设置：
   - `SHOPIFY_STORE_DOMAIN` 或 `SHOP`
   - `SHOPIFY_ACCESS_TOKEN` 或 `ADMIN_TOKEN`
   - `PORT`（通常由 Railway 自动设置）

### 步骤 3: 检查服务状态

1. 打开 "Metrics" 标签
2. 查看 CPU、内存使用情况
3. 查看请求日志

### 步骤 4: 测试健康检查

访问：
- `https://your-railway-url.up.railway.app/health`
- `https://your-railway-url.up.railway.app/api/health`

应该返回：
```json
{
  "status": "ok"
}
```
或
```json
{
  "status": "healthy",
  "timestamp": "...",
  "service": "Shopify 3D Printing Service"
}
```

---

## 快速修复命令

### 重新部署
在 Railway 项目中点击 "Redeploy"

### 查看实时日志
在 Railway 项目页面打开 "Logs" 标签

### 清理缓存
如果部署出现问题，可以：
1. 删除 Railway 服务
2. 重新创建服务
3. 重新连接 GitHub 仓库

---

## 联系支持

如果问题仍未解决，请提供：
1. Railway 部署日志（完整错误堆栈）
2. 环境变量配置（隐藏敏感信息）
3. 部署时间戳
4. 服务状态截图

---

## 验证清单

部署成功后，请验证：

- [ ] 服务器启动成功（查看日志）
- [ ] 健康检查端点正常（`/health`）
- [ ] API 端点可访问（`/api/health`）
- [ ] 环境变量已配置
- [ ] 文件上传功能正常
- [ ] 文件下载功能正常
- [ ] Draft Order 创建正常

---

## 常见问题 FAQ

### Q: Railway 会自动使用 PORT 环境变量吗？
A: 是的，Railway 会自动设置 `PORT` 环境变量。服务器代码已配置为使用 `process.env.PORT || 8080`。

### Q: 是否需要手动配置端口？
A: 不需要。Railway 会自动分配端口，并通过 `PORT` 环境变量传递。

### Q: 为什么文件上传失败？
A: 可能的原因：
1. `SKIP_SHOPIFY_FILES=true` 已设置（会跳过 Shopify Files）
2. Shopify API 凭据不正确
3. 网络连接问题
4. FormData 构建错误

### Q: 如何查看实时日志？
A: 在 Railway 项目页面打开 "Logs" 标签，可以看到实时日志输出。

### Q: 部署需要多长时间？
A: 通常 2-5 分钟，取决于：
- 依赖安装时间
- Docker 镜像构建时间
- 网络速度

---

**最后更新**: 2025-01-21

