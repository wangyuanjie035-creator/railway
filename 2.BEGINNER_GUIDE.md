# 3D模型报价系统 - 初学者入门指南

## 👋 欢迎

欢迎来到 3D 模型定制报价系统！这份指南将帮助你理解系统的工作原理，即使你是编程初学者也能轻松上手。

---

## 📚 目录

1. [系统是什么](#系统是什么)
2. [技术栈介绍](#技术栈介绍)
3. [关键概念解释](#关键概念解释)
4. [文件结构说明](#文件结构说明)
5. [如何开始](#如何开始)
6. [常见问题](#常见问题)
7. [学习资源](#学习资源)

---

## 系统是什么

### 业务场景

想象一个场景：
- 你经营一家 3D 打印服务公司
- 客户需要定制加工 3D 模型
- 客户上传模型文件（如 STEP、STL 格式）
- 你查看文件和参数，给出报价
- 客户收到报价后决定是否下单

**这个系统就是为了自动化这个流程！**

### 系统功能

```
客户端功能:
✅ 上传 3D 模型文件
✅ 配置加工参数（材料、精度、数量等）
✅ 提交询价请求
✅ 查看购物车中的询价状态

管理端功能:
✅ 查看所有客户询价
✅ 下载客户上传的文件
✅ 查看加工参数详情
✅ 添加报价和备注
✅ 发送报价邮件给客户
✅ 删除已完成的订单
```

---

## 技术栈介绍

### 1. Shopify - 电商平台

**是什么？**
- 一个在线商店平台，类似淘宝店铺
- 提供商品管理、购物车、结账等功能
- 我们在 Shopify 上搭建了这个报价系统

**为什么选择 Shopify？**
- 无需自己搭建服务器
- 自带用户系统和支付功能
- 提供强大的 API 接口
- 可以自定义页面和功能

**关键组件**:
- **Liquid**: Shopify 的模板语言，类似 HTML
- **Metaobjects**: 自定义数据类型（存储报价记录）
- **Files API**: 文件存储系统
- **GraphQL API**: 数据操作接口

### 2. Vercel - 后端服务

**是什么？**
- 一个云服务平台，用来部署后端代码
- 提供 Serverless Functions（无服务器函数）
- 代码上传后自动运行，无需管理服务器

**为什么使用 Vercel？**
- 免费额度足够小型项目使用
- 自动扩展，流量大时自动增加资源
- 部署简单，推送代码即可
- 全球 CDN 加速

**我们的 API**:
```
/api/upload-file.js    - 处理文件上传
/api/quotes-restored.js - 管理报价记录
/api/send-email.js     - 生成邮件内容
/api/download-file.js  - 下载文件
/api/cleanup-files.js  - 清理文件
```

### 3. JavaScript - 编程语言

**前端 JavaScript**:
- 运行在浏览器中
- 处理用户交互（点击、输入等）
- 发送网络请求到后端
- 更新页面内容

**后端 JavaScript (Node.js)**:
- 运行在 Vercel 服务器上
- 处理文件上传
- 操作 Shopify 数据
- 生成邮件内容

### 4. GraphQL - 数据查询语言

**是什么？**
- 一种 API 查询语言，类似 SQL
- 可以精确指定需要的数据字段
- 一次请求可以获取多个资源

**示例**:
```graphql
# 查询所有报价记录
query {
  metaobjects(type: "quote", first: 50) {
    nodes {
      id
      handle
      fields {
        key
        value
      }
    }
  }
}
```

**对比 REST API**:
```
REST:
GET /api/quotes        - 获取所有字段（可能有冗余）
GET /api/quotes/123    - 需要多次请求

GraphQL:
POST /graphql          - 一次请求，精确指定字段
{
  query { ... }
}
```

---

## 关键概念解释

### 1. Metaobject（元对象）

**简单理解**: 就像 Excel 表格，可以自定义列名和数据类型。

**我们的两个 Metaobject**:

#### Quote (报价记录)
```
┌──────────────┬──────────┬────────────────────────────┐
│ 字段名       │ 类型     │ 说明                       │
├──────────────┼──────────┼────────────────────────────┤
│ text         │ 文本     │ 文件名                     │
│ author       │ 文本     │ 客户信息 + 加工参数        │
│ status       │ 文本     │ 状态 (Pending/Quoted)      │
│ price        │ 文本     │ 报价金额                   │
│ invoice_url  │ 文本     │ 文件下载链接               │
└──────────────┴──────────┴────────────────────────────┘
```

#### Uploaded_file (文件元数据)
```
┌──────────────┬──────────┬────────────────────────────┐
│ 字段名       │ 类型     │ 说明                       │
├──────────────┼──────────┼────────────────────────────┤
│ file_id      │ 文本     │ 唯一文件ID                 │
│ file_name    │ 文本     │ 原始文件名                 │
│ file_type    │ 文本     │ 文件类型 (MIME)            │
│ file_url     │ 文本     │ Shopify CDN 地址           │
│ shopify_file_id│ 文本   │ Shopify Files 中的ID       │
│ order_id     │ 文本     │ 关联的报价ID               │
│ upload_time  │ 文本     │ 上传时间                   │
│ file_size    │ 文本     │ 文件大小（字节）           │
└──────────────┴──────────┴────────────────────────────┘
```

**为什么不用数据库？**
- Shopify 提供了 Metaobject 作为数据存储
- 无需额外配置数据库
- 与 Shopify 系统深度集成
- 自动备份和安全保护

### 2. Base64 编码

**问题**: 文件是二进制数据（0和1），无法直接在文本中传输。

**解决**: Base64 将二进制转换为文本。

**示例**:
```
原始文件 (二进制):
01010011 01010100 01000101 01010000

Base64 编码后 (文本):
U1RFUA==

Data URI 格式:
data:application/step;base64,U1RFUA==
```

**为什么需要？**
- JSON 格式只能传输文本
- HTTP 请求体需要文本格式
- Base64 是标准的编码方式

**代码示例**:
```javascript
// 前端读取文件
const file = document.getElementById('file-input').files[0];
const reader = new FileReader();

reader.onload = function(e) {
  // e.target.result 就是 Base64 编码的文件
  const base64Data = e.target.result;
  console.log(base64Data);
  // "data:application/step;base64,U1RFUCBGSUxF..."
};

reader.readAsDataURL(file);
```

### 3. CORS (跨域资源共享)

**问题**: 浏览器安全策略阻止跨域请求。

**场景**:
```
前端域名: https://sain-pdc-test.myshopify.com
后端域名: https://shopify-13s4.vercel.app

浏览器: "这两个域名不一样，不允许请求！"
```

**解决**: 后端设置 CORS 头，告诉浏览器"允许这个域名访问"。

**代码**:
```javascript
// 后端 API 设置
res.setHeader('Access-Control-Allow-Origin', 'https://sain-pdc-test.myshopify.com');
res.setHeader('Access-Control-Allow-Methods', 'GET,POST,PATCH,DELETE');
res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
```

**OPTIONS 预检请求**:
```
浏览器在发送真正的请求前，会先发送一个 OPTIONS 请求：
"我可以访问这个 API 吗？"

后端回复:
"可以，允许的方法有 GET、POST..."

浏览器:
"好的，那我发送真正的请求"
```

### 4. Staged Upload (分步上传)

**问题**: 大文件直接上传到 Shopify API 会超时。

**解决**: 分两步上传。

**流程**:
```
步骤 1: 申请临时上传地址
┌─────────┐                    ┌─────────┐
│  后端   │ stagedUploadsCreate│ Shopify │
│         ├───────────────────>│         │
│         │                    │         │
│         │ 返回临时 URL        │         │
│         │<───────────────────│         │
└─────────┘                    └─────────┘

步骤 2: 上传文件到临时地址
┌─────────┐                    ┌─────────────┐
│  后端   │  POST 文件         │ Google Cloud│
│         ├───────────────────>│  Storage    │
│         │                    │             │
│         │  上传成功          │             │
│         │<───────────────────│             │
└─────────┘                    └─────────────┘

步骤 3: 创建永久记录
┌─────────┐                    ┌─────────┐
│  后端   │   fileCreate       │ Shopify │
│         ├───────────────────>│         │
│         │                    │         │
│         │ 返回文件 ID 和 URL  │         │
│         │<───────────────────│         │
└─────────┘                    └─────────┘
```

**好处**:
- 支持大文件（最大 100MB）
- 上传速度快（直传到 Google Cloud）
- 不会超时
- 自动提供 CDN 加速

### 5. Serverless Functions (无服务器函数)

**传统服务器**:
```
需要:
- 购买服务器
- 安装操作系统
- 配置环境
- 部署代码
- 监控运行
- 处理扩展
```

**Serverless**:
```
只需:
- 写代码
- 上传到 Vercel
- 自动运行

Vercel 负责:
- 服务器管理
- 自动扩展
- 负载均衡
- 监控日志
```

**计费方式**:
- 按实际使用量计费
- 没有请求就不收费
- 免费额度足够小项目

**我们的函数**:
```javascript
// api/quotes-restored.js
export default async function handler(req, res) {
  // 处理请求
  if (req.method === 'GET') {
    // 返回所有报价
  }
  if (req.method === 'POST') {
    // 创建新报价
  }
}
```

### 6. Liquid 模板语言

**是什么？**
- Shopify 的模板语言
- 类似 HTML，但可以插入变量和逻辑

**示例**:
```liquid
{% comment %}
  这是注释
{% endcomment %}

<div class="order-item">
  <h3>{{ order.text }}</h3>
  
  {% if order.price %}
    <p>报价: ¥{{ order.price }}</p>
  {% else %}
    <p>待报价</p>
  {% endif %}
  
  {% for field in order.fields %}
    <span>{{ field.key }}: {{ field.value }}</span>
  {% endfor %}
</div>
```

**语法**:
- `{{ variable }}` - 输出变量
- `{% if condition %}` - 条件判断
- `{% for item in array %}` - 循环
- `{% comment %}` - 注释

---

## 文件结构说明

### 项目目录

```
项目根目录/
│
├── api/                          # 后端 API (Vercel Functions)
│   ├── quotes-restored.js        # 报价记录管理 (增删改查)
│   ├── upload-file.js            # 文件上传处理
│   ├── download-file.js          # 文件下载代理
│   ├── send-email.js             # 邮件内容生成
│   └── cleanup-files.js          # 文件清理
│
├── assets/                       # 前端资源文件
│   ├── model-uploader.js         # 3D模型上传器 (核心前端逻辑)
│   ├── model-uploader.css        # 上传器样式
│   ├── quote-notification.js     # 报价通知 (实时更新)
│   └── ...                       # 其他资源文件
│
├── templates/                    # Shopify 页面模板
│   ├── page.admin-dashboard.liquid  # 管理后台页面
│   ├── cart.quote.liquid            # 购物车页面
│   ├── page.model-uploader.json     # 上传器页面配置
│   └── ...                          # 其他模板
│
├── sections/                     # Shopify 可重用组件
│   ├── model-uploader.liquid     # 上传器组件
│   └── ...                       # 其他组件
│
├── config/                       # Shopify 配置
│   ├── settings_data.json        # 主题设置数据
│   └── settings_schema.json      # 主题设置结构
│
├── SYSTEM_WORKFLOW.md            # 系统工作流程文档
├── BEGINNER_GUIDE.md             # 初学者指南 (本文件)
├── DEPLOYMENT_GUIDE.md           # 部署指南
└── package.json                  # 项目依赖配置
```

### 核心文件说明

#### 1. 前端文件

**`assets/model-uploader.js`** (2481 行)
- 客户上传 3D 模型的主要逻辑
- 处理文件选择、验证、预览
- 收集加工参数
- 调用后端 API
- 显示上传进度和错误

**`templates/page.admin-dashboard.liquid`** (1758 行)
- 客服管理后台界面
- 显示所有客户询价
- 提供下载、预览、报价功能
- 发送报价邮件
- 删除订单

**`templates/cart.quote.liquid`** (114 行)
- 购物车页面
- 显示询价商品
- "立即下单"按钮

#### 2. 后端文件

**`api/quotes-restored.js`** (305 行)
- 报价记录的增删改查
- GET: 获取所有报价
- POST: 创建新报价
- PATCH: 更新报价（添加价格）
- DELETE: 删除报价

**`api/upload-file.js`** (284 行)
- 处理文件上传
- 使用 Shopify Staged Upload
- 存储文件到 Shopify Files
- 保存元数据到 Metaobject

**`api/send-email.js`** (约 100 行)
- 生成报价邮件内容
- 返回 mailto: 链接
- 支持 HTML 格式邮件

---

## 如何开始

### 1. 环境准备

**需要的工具**:
- 代码编辑器（推荐 VS Code）
- Node.js（用于本地测试）
- Git（版本控制）
- Shopify 账号
- Vercel 账号

**安装步骤**:
```bash
# 1. 克隆项目
git clone <项目地址>

# 2. 进入项目目录
cd <项目目录>

# 3. 安装依赖
npm install

# 4. 配置环境变量（仅本地开发需要）
# 复制示例文件
cp env.example .env

# 编辑 .env 文件，填写你的实际值
# SHOPIFY_STORE_DOMAIN=your-store.myshopify.com
# SHOPIFY_ACCESS_TOKEN=your-access-token

# 注意：生产环境的环境变量在 Vercel 后台配置，不是在 .env 文件中
```

### 2. 本地开发

**启动 Vercel 开发服务器**:
```bash
vercel dev
```

**访问**:
- 前端: `http://localhost:3000`
- API: `http://localhost:3000/api/quotes`

### 3. 部署到生产环境

**部署到 Vercel**:
```bash
# 登录 Vercel
vercel login

# 部署
vercel --prod
```

**配置 Shopify**:
1. 上传主题文件到 Shopify
2. 在 Shopify 后台配置 Metaobject 定义
3. 创建 Admin API Token
4. 在 Vercel 设置环境变量

详细步骤请参考 `DEPLOYMENT_GUIDE.md`

### 4. 测试流程

**客户端测试**:
1. 访问产品页面
2. 上传一个测试文件（如 test.step）
3. 填写加工参数
4. 点击"添加到购物车"
5. 在购物车点击"立即下单"

**管理端测试**:
1. 访问 `/pages/admin-dashboard`
2. 查看是否显示刚才的订单
3. 点击"下载"查看文件
4. 点击"预览"查看参数
5. 点击"添加报价"填写价格
6. 点击"提交报价"生成邮件

---

## 常见问题

### Q1: 我不懂编程，能理解这个系统吗？

**A**: 可以！这份指南就是为初学者准备的。建议按以下顺序学习：
1. 先理解业务流程（客户上传 → 客服报价）
2. 再学习基本概念（Metaobject、Base64 等）
3. 然后阅读代码注释
4. 最后尝试修改简单的功能

### Q2: 我想修改界面样式，应该改哪个文件？

**A**: 
- 上传器样式: `assets/model-uploader.css`
- 管理后台样式: `templates/page.admin-dashboard.liquid` 中的 `<style>` 标签
- 购物车样式: `templates/cart.quote.liquid` 中的 `<style>` 标签

### Q3: 我想添加新的加工参数，怎么做？

**A**: 需要修改三个地方：
1. `sections/model-uploader.liquid` - 添加表单字段
2. `assets/model-uploader.js` - 收集新参数
3. `templates/page.admin-dashboard.liquid` - 显示新参数

### Q4: 文件上传失败，如何排查？

**A**: 检查以下几点：
1. 浏览器控制台是否有错误信息
2. Vercel 日志是否有错误
3. 文件大小是否超过 100MB
4. Shopify API Token 权限是否正确
5. 网络连接是否正常

### Q5: 如何查看 API 请求和响应？

**A**: 使用浏览器开发者工具：
1. 按 F12 打开开发者工具
2. 切换到"网络"(Network) 标签
3. 执行操作（如上传文件）
4. 查看请求列表
5. 点击请求查看详细信息（请求头、响应体等）

### Q6: Metaobject 和数据库有什么区别？

**A**: 
- **相同点**: 都用于存储结构化数据
- **不同点**: 
  - Metaobject 是 Shopify 提供的，无需额外配置
  - 数据库需要自己搭建和维护
  - Metaobject 字段固定，数据库更灵活
  - Metaobject 与 Shopify 深度集成

### Q7: 为什么使用 GraphQL 而不是 REST API？

**A**: 
- Shopify Admin API 主要使用 GraphQL
- GraphQL 可以精确指定需要的字段
- 减少数据传输量
- 一次请求可以获取多个资源
- 有完整的类型系统和文档

### Q8: 邮件为什么不是自动发送？

**A**: 
- Vercel Serverless Functions 不支持 SMTP
- 使用第三方邮件服务需要额外配置和费用
- `mailto:` 方案简单可靠
- 客服可以在发送前检查邮件内容

---

## 学习资源

### 官方文档

**Shopify**:
- [Shopify Liquid 文档](https://shopify.dev/docs/api/liquid)
- [Shopify GraphQL API](https://shopify.dev/docs/api/admin-graphql)
- [Shopify Metaobjects](https://shopify.dev/docs/apps/custom-data/metaobjects)
- [Shopify Files API](https://shopify.dev/docs/api/admin-graphql/latest/mutations/fileCreate)

**Vercel**:
- [Vercel Serverless Functions](https://vercel.com/docs/functions)
- [Vercel 部署指南](https://vercel.com/docs/deployments)
- [环境变量配置](https://vercel.com/docs/projects/environment-variables)

**JavaScript**:
- [MDN JavaScript 教程](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript)
- [JavaScript.info](https://zh.javascript.info/)
- [Node.js 文档](https://nodejs.org/zh-cn/docs/)

### 视频教程

**Shopify 开发**:
- YouTube 搜索 "Shopify Theme Development"
- YouTube 搜索 "Shopify Liquid Tutorial"

**JavaScript 基础**:
- YouTube 搜索 "JavaScript Tutorial for Beginners"
- B站搜索 "JavaScript 入门教程"

### 推荐学习路径

**第 1 周**: 基础概念
- 了解 Shopify 是什么
- 学习 HTML/CSS 基础
- 理解 JavaScript 变量和函数

**第 2 周**: Liquid 模板
- 学习 Liquid 语法
- 修改简单的模板
- 理解 Shopify 对象（product, cart 等）

**第 3 周**: JavaScript 交互
- 学习 DOM 操作
- 理解事件监听
- 发送 AJAX 请求

**第 4 周**: 后端 API
- 学习 Node.js 基础
- 理解 HTTP 请求/响应
- 学习 GraphQL 查询

**第 5 周**: 实践项目
- 阅读本项目代码
- 尝试修改功能
- 添加新特性

---

## 调试技巧

### 1. 浏览器开发者工具

**打开方式**:
- Windows: `F12` 或 `Ctrl + Shift + I`
- Mac: `Cmd + Option + I`

**常用标签**:
- **Console (控制台)**: 查看 `console.log()` 输出和错误
- **Network (网络)**: 查看 API 请求和响应
- **Elements (元素)**: 查看和修改 HTML/CSS
- **Sources (源代码)**: 设置断点调试 JavaScript

### 2. 添加调试日志

**前端**:
```javascript
console.log('文件上传开始', file);
console.log('Base64 数据长度:', base64Data.length);
console.log('API 响应:', response);
```

**后端**:
```javascript
console.log('收到上传请求:', req.body.fileName);
console.log('文件大小:', fileBuffer.length);
console.log('Shopify 响应:', result);
```

### 3. 查看 Vercel 日志

1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 选择你的项目
3. 点击"Logs"标签
4. 查看实时日志输出

### 4. 测试 API 端点

使用 Postman 或 curl 测试：

```bash
# 测试获取报价列表
curl https://shopify-13s4.vercel.app/api/quotes

# 测试创建报价
curl -X POST https://shopify-13s4.vercel.app/api/quotes \
  -H "Content-Type: application/json" \
  -d '{"text":"test.step","author":"测试","email":"test@example.com"}'
```

---

## 下一步

1. ✅ 阅读完本指南
2. 📖 查看 `SYSTEM_WORKFLOW.md` 了解详细流程
3. 💻 阅读核心文件的代码注释
4. 🧪 在测试环境中尝试完整流程
5. 🔧 尝试修改简单的功能
6. 🚀 部署到生产环境

---

## 获取帮助

**遇到问题？**
1. 检查浏览器控制台错误
2. 查看 Vercel 日志
3. 阅读相关文档
4. 搜索错误信息
5. 查看项目的 Issues

**学习建议**:
- 不要急于求成，一步一步来
- 多动手实践，不要只看不做
- 遇到不懂的概念，先搜索学习
- 善用开发者工具调试
- 保持耐心和好奇心

---

**祝你学习愉快！🎉**

**文档版本**: 1.0  
**最后更新**: 2025-01-29  
**维护者**: AI Assistant

