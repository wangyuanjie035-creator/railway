# 代码文档索引

## 📖 文档状态

本文档提供所有核心文件的快速索引和关键函数说明。

---

## ✅ 已完成详细注释的文件

### 1. `api/send-email.js` ✅ (完整注释)
**文件大小**: 295 行  
**完成度**: 100%  
**功能**: 生成报价邮件内容

**关键函数**:
- `handler(req, res)` - 主处理函数，生成邮件内容和 mailto: 链接

**重点注释**:
- ✅ CORS 设置说明
- ✅ 请求参数验证
- ✅ 纯文本邮件生成
- ✅ HTML 邮件生成
- ✅ mailto: 链接生成
- ✅ 概念说明（为什么不用 SMTP）

---

## 📝 核心文件快速参考

### 2. `api/quotes-restored.js` (305 行)
**功能**: 报价记录的增删改查（CRUD）

**关键函数**:
```javascript
// 1. shopGql(query, variables) - Shopify GraphQL API 调用封装
//    - 发送 GraphQL 请求到 Shopify
//    - 自动添加认证头
//    - 返回 JSON 响应

// 2. handler(req, res) - 主处理函数
//    - GET: 获取所有报价记录
//    - POST: 创建新报价记录
//    - PATCH: 更新报价（添加价格）
//    - DELETE: 删除报价并清理文件
```

**重要逻辑**:
- **POST 请求**: 强制设置 status 为 "Pending"，合并客户信息和参数到 author 字段
- **PATCH 请求**: 支持部分匹配 handle（模糊查找）
- **DELETE 请求**: 真正删除记录（不是标记为 Deleted），并调用文件清理 API

**数据流**:
```
前端 → POST /api/quotes → Shopify metaobjectCreate → 返回新记录
前端 → PATCH /api/quotes?handle=xxx → Shopify metaobjectUpdate → 返回更新后记录
前端 → DELETE /api/quotes?handle=xxx → Shopify metaobjectDelete → 调用 cleanup-files
```

---

### 3. `api/upload-file.js` (284 行)
**功能**: 处理文件上传到 Shopify Files

**关键函数**:
```javascript
// 1. shopGql(query, variables) - 本地实现的 GraphQL 调用
//    - 避免跨路由导入问题
//    - 与 quotes-restored.js 中的实现相同

// 2. handler(req, res) - 主处理函数
//    - 接收 Base64 编码的文件
//    - 使用 Shopify Staged Upload 流程
//    - 存储文件元数据到 Metaobject
```

**Staged Upload 流程**:
```
步骤 1: stagedUploadsCreate
  ↓ 获取临时上传 URL

步骤 2: POST 文件到临时 URL
  ↓ 使用 multipart/form-data

步骤 3: fileCreate
  ↓ 创建永久文件记录

步骤 4: metaobjectCreate (uploaded_file)
  ↓ 保存文件元数据

返回: fileUrl (下载链接)
```

**关键技术点**:
- **Base64 解码**: `Buffer.from(base64Payload, 'base64')`
- **Multipart 构建**: 手动构建 multipart/form-data 边界和正文
- **MIME 类型映射**: 将 MIME 类型映射到 Shopify 的 contentType 枚举
- **CDN URL**: 优先使用 `target.resourceUrl` 作为永久 URL

---

### 4. `assets/model-uploader.js` (2481 行)
**功能**: 客户端 3D 模型上传器

**核心类/对象**:
```javascript
// fileManager - 文件管理器
{
  files: Map(),           // 存储所有文件及配置
  currentFileId: null,    // 当前选中的文件
  nextFileId: 1,          // 下一个文件ID
  fileAssociations: Map() // 文件关联关系
}
```

**关键函数**:
```javascript
// 1. init() - 初始化上传器
//    - 获取 DOM 元素
//    - 初始化 3D 查看器
//    - 绑定事件监听器

// 2. handleFileSelect(event) - 处理文件选择
//    - 验证文件类型和大小
//    - 读取文件为 Base64
//    - 添加到文件列表

// 3. handleAddToCart() - 添加到购物车
//    - 收集所有参数
//    - 上传文件到 /api/upload-file
//    - 创建报价记录到 /api/quotes
//    - 添加商品到 Shopify 购物车

// 4. collectParameters() - 收集加工参数
//    - 材料、精度、公差等
//    - 返回参数对象

// 5. getCustomerInfo() - 获取客户信息
//    - 从 window.customerState 获取
//    - 从 window.Shopify.customer 获取
//    - 从 URL 参数获取
//    - 从 localStorage 获取
```

**文件上传流程**:
```
1. 用户选择文件
   ↓
2. FileReader.readAsDataURL() 读取为 Base64
   ↓
3. POST /api/upload-file { fileData, fileName, fileType }
   ↓
4. 获取 fileUrl
   ↓
5. POST /api/quotes { text, author, invoice_url: fileUrl }
   ↓
6. 添加到 Shopify 购物车
   ↓
7. 跳转到购物车页面
```

---

### 5. `templates/page.admin-dashboard.liquid` (1758 行)
**功能**: 客服管理后台界面

**主要区域**:
```html
<!-- 1. 统计卡片 -->
<div class="stats-grid">
  - 待处理订单数
  - 已报价订单数
  - 总订单数
</div>

<!-- 2. 订单列表 -->
<div class="orders-list">
  - 循环显示所有订单
  - 每个订单显示文件名、客户、状态、价格
</div>

<!-- 3. 操作按钮 -->
- 下载文件
- 预览参数
- 添加报价
- 删除订单
```

**关键 JavaScript 函数**:
```javascript
// 1. loadOrders() - 加载订单列表
//    - GET /api/quotes
//    - 渲染订单卡片
//    - 更新统计数据

// 2. downloadFile(url, fileName) - 下载文件
//    - 检查 URL 类型（data:、http://、https://）
//    - 处理不同的下载方式

// 3. openPreviewModal(order) - 预览参数
//    - 从 author 字段解析参数
//    - 显示在模态框中

// 4. openQuoteModal(order) - 添加报价
//    - 显示报价表单
//    - 提取客户邮箱

// 5. submitQuote(orderId) - 提交报价
//    - PATCH /api/quotes?handle=xxx
//    - POST /api/send-email
//    - 显示邮件对话框

// 6. showEmailDialog(emailData) - 显示邮件对话框
//    - 显示邮件内容
//    - 提供"打开邮件客户端"和"复制内容"选项

// 7. deleteOrder(handle) - 删除订单
//    - 确认对话框
//    - DELETE /api/quotes?handle=xxx
//    - 刷新列表
```

**参数解析逻辑**:
```javascript
// author 字段格式:
// "张三 (zhang@example.com) | 数量:10件 | 材料:ABS | 精度:高精度 | ..."

// 解析步骤:
1. 提取邮箱: /\(([^)]+)\)/.exec(authorField)
2. 分割参数: authorField.split('|')
3. 解析键值对: param.split(':')
```

---

## 🔄 数据流程图

### 完整工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                     客户上传文件                             │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────┐
        │   model-uploader.js (前端)      │
        │   - 读取文件为 Base64           │
        │   - 收集加工参数                │
        └─────────────────────────────────┘
                          │
            ┌─────────────┴─────────────┐
            │                           │
            ▼                           ▼
┌───────────────────────┐   ┌───────────────────────┐
│  /api/upload-file     │   │   /api/quotes         │
│  - Staged Upload      │   │   - 创建报价记录      │
│  - 存储到 Shopify     │   │   - 状态: Pending     │
└───────────────────────┘   └───────────────────────┘
            │                           │
            └─────────────┬─────────────┘
                          │
                          ▼
        ┌─────────────────────────────────┐
        │     Shopify Metaobjects         │
        │   - quote (报价记录)            │
        │   - uploaded_file (文件元数据)  │
        └─────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   客服审核和报价                             │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────┐
        │  admin-dashboard.liquid (前端)  │
        │  - 显示订单列表                 │
        │  - 下载文件                     │
        │  - 添加报价                     │
        └─────────────────────────────────┘
                          │
            ┌─────────────┴─────────────┐
            │                           │
            ▼                           ▼
┌───────────────────────┐   ┌───────────────────────┐
│  PATCH /api/quotes    │   │  POST /api/send-email │
│  - 更新价格和状态     │   │  - 生成邮件内容       │
└───────────────────────┘   └───────────────────────┘
                                        │
                                        ▼
                        ┌───────────────────────────┐
                        │   mailto: 链接            │
                        │   打开邮件客户端          │
                        └───────────────────────────┘
```

---

## 📚 关键概念速查

### 1. Shopify Metaobject
- 自定义数据类型，类似数据库表
- 字段固定，创建后不可动态添加
- 通过 GraphQL API 操作

### 2. Base64 编码
- 将二进制文件转换为文本格式
- 用于在 JSON 中传输文件
- 格式: `data:mime/type;base64,编码内容`

### 3. Staged Upload
- Shopify 的分步上传机制
- 支持大文件（最大 100MB）
- 流程: 申请地址 → 上传文件 → 创建记录

### 4. CORS
- 跨域资源共享
- 允许不同域名之间的 API 调用
- 需要在后端设置响应头

### 5. GraphQL
- Shopify Admin API 使用的查询语言
- 可以精确指定需要的字段
- 一次请求可以操作多个资源

---

## 🔧 调试技巧

### 查看 API 请求
```javascript
// 浏览器控制台 (F12)
// Network 标签 → 查看请求和响应
```

### 查看 Vercel 日志
```
1. 访问 Vercel Dashboard
2. 选择项目
3. 点击 "Logs" 标签
4. 查看实时日志
```

### 测试 API
```bash
# 使用 curl 测试
curl https://shopify-13s4.vercel.app/api/quotes

# 使用 Postman 测试
POST https://shopify-13s4.vercel.app/api/quotes
Content-Type: application/json
{
  "text": "test.step",
  "author": "测试",
  "email": "test@example.com"
}
```

---

## 📖 下一步

1. ✅ 阅读 `SYSTEM_WORKFLOW.md` - 了解完整工作流程
2. ✅ 阅读 `BEGINNER_GUIDE.md` - 学习基础概念
3. ✅ 阅读 `api/send-email.js` - 查看完整注释示例
4. 📝 阅读本文档 - 快速了解所有核心文件
5. 💻 查看实际代码 - 结合注释深入学习
6. 🧪 在测试环境中实践 - 动手操作加深理解

---

**文档版本**: 1.0  
**最后更新**: 2025-01-29  
**维护者**: AI Assistant

**注意**: 由于核心文件较大（数千行代码），完整的逐行注释会使文件过于冗长。本文档提供了关键函数和流程的说明，配合 `SYSTEM_WORKFLOW.md` 和 `BEGINNER_GUIDE.md` 可以全面理解系统。如需特定函数的详细注释，请参考代码中的现有注释或查阅相关文档。

