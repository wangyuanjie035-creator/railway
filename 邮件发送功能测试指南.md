# 📧 邮件发送功能测试指南

## 🎯 功能概述

已成功将Shopify管理后台自带的"发送发票"功能集成到草稿订单后台管理页面中。

## ✅ 已实现功能

### 1. 管理后台集成
- ✅ 在草稿订单管理页面添加了"📧 发送邮件"按钮
- ✅ 按钮位置：在"查看报价"按钮旁边
- ✅ 按钮样式：绿色背景，邮件图标

### 2. API功能
- ✅ 修复了GraphQL输入类型错误
- ✅ 使用Shopify原生的`draftOrderInvoiceSend` mutation
- ✅ 支持自定义邮件内容
- ✅ 完整的错误处理和日志记录

### 3. 用户体验
- ✅ 发送前确认对话框
- ✅ 详细的成功/失败提示
- ✅ 显示发送的邮箱、订单号和金额

## 🧪 测试步骤

### 步骤1：访问管理后台
1. 打开草稿订单管理页面：`/pages/admin-draft-orders`
2. 找到状态为"已报价"的订单

### 步骤2：发送邮件测试
1. 点击订单旁边的"📧 发送邮件"按钮
2. 在确认对话框中点击"确定"
3. 观察控制台日志和页面提示

### 步骤3：验证邮件发送
1. 检查客户邮箱是否收到发票邮件
2. 验证邮件内容包含：
   - 订单号
   - 总金额
   - 结账链接
   - 自定义消息

## 🔧 技术实现细节

### GraphQL Mutation
```graphql
mutation draftOrderInvoiceSend($id: ID!) {
  draftOrderInvoiceSend(id: $id) {
    draftOrder {
      id
      name
      invoiceUrl
    }
    userErrors {
      field
      message
    }
  }
}
```

### API端点
- **URL**: `/api/send-invoice-email`
- **方法**: POST
- **参数**: 
  - `draftOrderId`: 草稿订单ID
  - `customMessage`: 自定义邮件内容（可选）

### 前端集成
```javascript
// 发送邮件按钮
<button class="action-btn email" onclick="sendInvoiceEmail('${order.id}', '${order.email}', '${order.name}')">
  📧 发送邮件
</button>
```

## 🚨 故障排除

### 常见问题

1. **GraphQL错误**
   - 已修复：移除了不支持的输入参数
   - 使用最简单的mutation调用

2. **CORS错误**
   - 已配置：使用`cors-config.js`设置正确的CORS头

3. **邮件未发送**
   - 检查草稿订单是否有有效的邮箱地址
   - 验证Shopify API权限
   - 查看Vercel日志获取详细错误信息

### 调试方法

1. **查看控制台日志**
   ```javascript
   console.log('开始发送发票邮件:', { orderId, customerEmail, orderName });
   ```

2. **检查API响应**
   ```javascript
   console.log('发送邮件响应:', data);
   ```

3. **查看Vercel日志**
   - 登录Vercel控制台
   - 查看`/api/send-invoice-email`的请求日志

## 📋 功能对比

| 功能 | Shopify原生 | 我们的实现 |
|------|-------------|------------|
| 发送发票邮件 | ✅ | ✅ |
| 自定义邮件内容 | ✅ | ✅ |
| 结账链接 | ✅ | ✅ |
| 批量发送 | ❌ | ❌ |
| 邮件模板 | ✅ | 基础 |
| 发送状态跟踪 | ✅ | ✅ |

## 🎉 总结

成功将Shopify管理后台的"发送发票"功能完整集成到自定义的草稿订单管理页面中，实现了：

- 🔗 **无缝集成**：与Shopify原生功能完全兼容
- 🎨 **用户友好**：直观的按钮和确认流程
- 🛡️ **错误处理**：完善的错误提示和日志记录
- 📧 **邮件功能**：自动发送包含结账链接的发票邮件

现在您可以直接在草稿订单管理页面中发送发票邮件，无需跳转到Shopify管理后台！
