{% comment %}
  文件上传处理页面
  这个页面处理文件上传请求并返回文件URL
{% endcomment %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>文件上传处理</title>
</head>
<body>
  <script>
    // 处理文件上传
    async function handleFileUpload() {
      try {
        const formData = new FormData();
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        
        if (!file) {
          throw new Error('请选择文件');
        }
        
        formData.append('file', file);
        formData.append('type', '3d_model');
        
        const response = await fetch('/apps/file-manager/upload', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
          },
        });
        
        if (!response.ok) {
          throw new Error('文件上传失败');
        }
        
        const result = await response.json();
        console.log('文件上传成功:', result);
        
        // 返回结果给父窗口
        if (window.parent && window.parent.postMessage) {
          window.parent.postMessage({
            type: 'FILE_UPLOAD_SUCCESS',
            fileUrl: result.fileUrl,
            fileName: file.name
          }, '*');
        }
      } catch (error) {
        console.error('文件上传失败:', error);
        if (window.parent && window.parent.postMessage) {
          window.parent.postMessage({
            type: 'FILE_UPLOAD_ERROR',
            error: error.message
          }, '*');
        }
      }
    }
    
    // 页面加载完成后自动处理上传
    document.addEventListener('DOMContentLoaded', function() {
      handleFileUpload();
    });
  </script>
  
  <input type="file" id="file-input" style="display: none;">
  <div>正在处理文件上传...</div>
</body>
</html>
