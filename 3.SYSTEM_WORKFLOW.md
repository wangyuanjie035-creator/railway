# 3D模型定制报价系统 - 工作流程详解

## 📋 目录
1. [系统概述](#系统概述)
2. [完整工作流程](#完整工作流程)
3. [数据流向图](#数据流向图)
4. [API调用时序](#api调用时序)
5. [数据结构说明](#数据结构说明)

---

## 系统概述

这是一个基于 Shopify 的 3D 模型定制加工报价系统，允许客户上传 3D 模型文件（如 STEP、STL 等），配置加工参数，提交询价请求，然后由客服人员审核并提供报价。

### 技术架构
```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   客户端    │ ◄────► │  Vercel API  │ ◄────► │   Shopify   │
│  (浏览器)   │         │  (后端服务)  │         │  (数据存储) │
└─────────────┘         └──────────────┘         └─────────────┘
```

- **前端**: Shopify Liquid 模板 + JavaScript
- **后端**: Vercel Serverless Functions (Node.js)
- **数据存储**: Shopify Metaobjects (自定义数据类型)
- **文件存储**: Shopify Files API
- **API通信**: Shopify GraphQL Admin API

---

## 完整工作流程

### 阶段 1: 客户上传文件 📤

```
客户操作流程：
1. 访问产品页面 (使用 model-uploader section)
2. 点击上传区域或拖拽文件
3. 选择 3D 模型文件 (STEP, STL, OBJ 等)
4. 配置加工参数：
   - 材料 (PLA, ABS, 金属等)
   - 精度等级 (标准, 高精度, 超高精度)
   - 公差标准 (GB/T 1804, ISO 2768)
   - 表面粗糙度 (Ra3.2, Ra1.6 等)
   - 是否有螺纹
   - 是否有装配标记
   - 缩放比例
   - 数量
   - 备注
5. 点击"添加到购物车"
6. 在购物车页面点击"立即下单"
```

**技术实现**:
- 文件: `assets/model-uploader.js`
- 文件读取为 Base64 编码
- 调用 `/api/upload-file` 上传文件
- 调用 `/api/quotes` 创建报价记录
- 文件和参数一起保存到 Shopify

### 阶段 2: 文件存储 💾

```
文件上传流程：
1. 前端发送 Base64 编码的文件到 /api/upload-file
2. 后端向 Shopify 申请临时上传地址 (Staged Upload)
3. 后端将文件上传到临时地址
4. Shopify 自动将文件移到永久存储 (Google Cloud Storage)
5. 后端在 Shopify Files 中创建文件记录
6. 后端在 uploaded_file Metaobject 中保存元数据
7. 返回文件下载 URL 给前端
```

**技术实现**:
- 文件: `api/upload-file.js`
- 使用 Shopify GraphQL `stagedUploadsCreate` mutation
- 使用 Shopify GraphQL `fileCreate` mutation
- 文件最终存储在 Shopify CDN

### 阶段 3: 报价记录创建 📝

```
报价创建流程：
1. 前端收集所有信息：
   - 文件名
   - 客户姓名和邮箱
   - 加工参数
   - 文件下载 URL
2. 发送 POST 请求到 /api/quotes
3. 后端创建 quote Metaobject:
   - text: 文件名
   - author: 客户信息 + 加工参数 (合并存储)
   - status: "Pending" (待处理)
   - price: 空 (待客服填写)
   - invoice_url: 文件下载链接
4. 返回创建成功的记录
```

**技术实现**:
- 文件: `api/quotes-restored.js` (POST 方法)
- 使用 Shopify GraphQL `metaobjectCreate` mutation
- 所有新记录强制设置为 "Pending" 状态

### 阶段 4: 客服审核和报价 👨‍💼

```
客服操作流程：
1. 访问管理后台 (/pages/admin-dashboard)
2. 查看待处理订单列表
3. 点击"下载"按钮下载客户上传的文件
4. 点击"预览"按钮查看加工参数详情
5. 分析文件和参数，计算报价
6. 点击"添加报价"按钮
7. 在弹窗中填写：
   - 报价金额
   - 备注说明
   - 发送邮箱 (客服邮箱)
   - 客户邮箱 (自动提取)
8. 点击"提交报价"
```

**技术实现**:
- 文件: `templates/page.admin-dashboard.liquid`
- GET 请求到 `/api/quotes` 获取所有订单
- PATCH 请求到 `/api/quotes?handle=xxx` 更新报价
- POST 请求到 `/api/send-email` 生成邮件内容

### 阶段 5: 邮件发送 📧

```
邮件发送流程：
1. 客服提交报价后，系统生成邮件内容
2. 调用 /api/send-email 生成 HTML 邮件
3. 返回 mailto: 链接
4. 弹出对话框显示邮件内容
5. 客服选择：
   a) 打开邮件客户端 (自动填充收件人、主题、正文)
   b) 复制邮件内容 (手动发送)
6. 客服通过邮件客户端发送邮件给客户
```

**技术实现**:
- 文件: `api/send-email.js`
- 生成 HTML 格式的邮件正文
- 返回 `mailto:` URL
- 前端使用 `window.open()` 打开邮件客户端

---

## 数据流向图

### 客户端 → 后端 → Shopify

```
┌──────────────────────────────────────────────────────────────┐
│                        客户上传文件                           │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ model-uploader.js│
                    │  (前端 JS)       │
                    └──────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
                ▼                           ▼
    ┌──────────────────┐      ┌──────────────────┐
    │ /api/upload-file │      │   /api/quotes    │
    │  (文件上传 API)  │      │  (报价记录 API)  │
    └──────────────────┘      └──────────────────┘
                │                           │
                ▼                           ▼
    ┌──────────────────┐      ┌──────────────────┐
    │ Shopify Files    │      │ quote Metaobject │
    │ (文件存储)       │      │ (报价记录)       │
    └──────────────────┘      └──────────────────┘
                │                           │
                └─────────────┬─────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ uploaded_file    │
                    │  Metaobject      │
                    │ (文件元数据)     │
                    └──────────────────┘
```

### 客服审核和报价

```
┌──────────────────────────────────────────────────────────────┐
│                      客服访问管理后台                         │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
                ┌──────────────────────────┐
                │ admin-dashboard.liquid   │
                │    (管理界面)            │
                └──────────────────────────┘
                              │
                ┌─────────────┼─────────────┐
                │             │             │
                ▼             ▼             ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ GET /quotes │ │PATCH /quotes│ │POST /send-  │
    │ (获取订单)  │ │ (更新报价)  │ │  email      │
    └─────────────┘ └─────────────┘ └─────────────┘
                │             │             │
                ▼             ▼             ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │   Shopify   │ │   Shopify   │ │  生成邮件   │
    │ Metaobjects │ │ Metaobjects │ │  内容       │
    └─────────────┘ └─────────────┘ └─────────────┘
                                            │
                                            ▼
                                  ┌─────────────────┐
                                  │  mailto: 链接   │
                                  │  打开邮件客户端 │
                                  └─────────────────┘
```

---

## API调用时序

### 1. 客户上传文件时序

```
客户浏览器                model-uploader.js           /api/upload-file              Shopify
    │                           │                           │                         │
    │  选择文件                 │                           │                         │
    ├──────────────────────────>│                           │                         │
    │                           │                           │                         │
    │                           │  读取文件为 Base64        │                         │
    │                           │──────────┐                │                         │
    │                           │          │                │                         │
    │                           │<─────────┘                │                         │
    │                           │                           │                         │
    │                           │  POST /api/upload-file    │                         │
    │                           │  { fileData, fileName }   │                         │
    │                           ├──────────────────────────>│                         │
    │                           │                           │                         │
    │                           │                           │  stagedUploadsCreate    │
    │                           │                           ├────────────────────────>│
    │                           │                           │                         │
    │                           │                           │  返回临时上传 URL       │
    │                           │                           │<────────────────────────│
    │                           │                           │                         │
    │                           │                           │  上传文件到临时地址     │
    │                           │                           ├────────────────────────>│
    │                           │                           │                         │
    │                           │                           │  fileCreate             │
    │                           │                           ├────────────────────────>│
    │                           │                           │                         │
    │                           │                           │  返回文件 ID 和 URL     │
    │                           │                           │<────────────────────────│
    │                           │                           │                         │
    │                           │                           │  metaobjectCreate       │
    │                           │                           │  (uploaded_file)        │
    │                           │                           ├────────────────────────>│
    │                           │                           │                         │
    │                           │  返回文件 URL             │                         │
    │                           │<──────────────────────────│                         │
    │                           │                           │                         │
    │                           │  POST /api/quotes         │                         │
    │                           │  { text, author, ... }    │                         │
    │                           ├──────────────────────────>│                         │
    │                           │                           │                         │
    │                           │                           │  metaobjectCreate       │
    │                           │                           │  (quote)                │
    │                           │                           ├────────────────────────>│
    │                           │                           │                         │
    │                           │  返回报价记录             │                         │
    │                           │<──────────────────────────│                         │
    │                           │                           │                         │
    │  显示成功消息             │                           │                         │
    │<──────────────────────────│                           │                         │
```

### 2. 客服添加报价时序

```
客服浏览器              admin-dashboard.liquid        /api/quotes              Shopify
    │                           │                           │                         │
    │  访问管理后台             │                           │                         │
    ├──────────────────────────>│                           │                         │
    │                           │                           │                         │
    │                           │  GET /api/quotes          │                         │
    │                           ├──────────────────────────>│                         │
    │                           │                           │                         │
    │                           │                           │  查询所有 quote         │
    │                           │                           ├────────────────────────>│
    │                           │                           │                         │
    │                           │  返回订单列表             │                         │
    │                           │<──────────────────────────│                         │
    │                           │                           │                         │
    │  显示订单列表             │                           │                         │
    │<──────────────────────────│                           │                         │
    │                           │                           │                         │
    │  点击"添加报价"           │                           │                         │
    ├──────────────────────────>│                           │                         │
    │                           │                           │                         │
    │  填写报价金额和备注       │                           │                         │
    ├──────────────────────────>│                           │                         │
    │                           │                           │                         │
    │  点击"提交报价"           │                           │                         │
    ├──────────────────────────>│                           │                         │
    │                           │                           │                         │
    │                           │  PATCH /api/quotes        │                         │
    │                           │  ?handle=xxx              │                         │
    │                           │  { price, status }        │                         │
    │                           ├──────────────────────────>│                         │
    │                           │                           │                         │
    │                           │                           │  metaobjectUpdate       │
    │                           │                           ├────────────────────────>│
    │                           │                           │                         │
    │                           │  返回更新后的记录         │                         │
    │                           │<──────────────────────────│                         │
    │                           │                           │                         │
    │                           │  POST /api/send-email     │                         │
    │                           │  { email, amount, ... }   │                         │
    │                           ├──────────────────────────>│                         │
    │                           │                           │                         │
    │                           │  返回 mailto: URL         │                         │
    │                           │<──────────────────────────│                         │
    │                           │                           │                         │
    │  显示邮件对话框           │                           │                         │
    │<──────────────────────────│                           │                         │
    │                           │                           │                         │
    │  打开邮件客户端           │                           │                         │
    │  (window.open mailto:)    │                           │                         │
    ├──────────────────────────>│                           │                         │
```

---

## 数据结构说明

### 1. Quote Metaobject (报价记录)

Shopify Metaobject 类型: `quote`

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `text` | String | 文件名 | `"model.STEP"` |
| `author` | String | 客户信息 + 加工参数 | `"张三 (zhang@example.com) \| 数量:10件 \| 材料:ABS \| 精度:高精度 \| ..."` |
| `status` | String | 订单状态 | `"Pending"` / `"Quoted"` / `"Completed"` |
| `price` | String | 报价金额 | `"1500.00"` |
| `invoice_url` | String | 文件下载链接 | `"https://shopify-13s4.vercel.app/api/download-file?id=file_xxx"` |

**为什么参数存储在 author 字段？**
- Shopify Metaobject 只支持预定义的字段
- 无法动态添加新字段
- 因此将所有参数序列化为字符串，存储在 `author` 字段中
- 格式: `客户名 (邮箱) | 参数1:值1 | 参数2:值2 | ...`

### 2. Uploaded_file Metaobject (文件元数据)

Shopify Metaobject 类型: `uploaded_file`

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `file_id` | String | 唯一文件ID | `"file_1759114189482_jt19vrzqj"` |
| `file_name` | String | 原始文件名 | `"model.STEP"` |
| `file_type` | String | MIME 类型 | `"application/step"` |
| `file_data` | String | 文件内容 (已废弃) | `""` (现在为空) |
| `file_url` | String | Shopify CDN URL | `"https://cdn.shopify.com/s/files/..."` |
| `shopify_file_id` | String | Shopify Files ID | `"gid://shopify/GenericFile/123456"` |
| `order_id` | String | 关联的订单ID | `"quote-abc123"` |
| `upload_time` | String | 上传时间 | `"2025-01-29T10:30:00.000Z"` |
| `file_size` | String | 文件大小(字节) | `"683520"` |

### 3. API 请求/响应格式

#### POST /api/upload-file

**请求体**:
```json
{
  "fileData": "data:application/step;base64,U1RFUCBGSUxF...",
  "fileName": "model.STEP",
  "fileType": "application/step",
  "orderId": "quote-abc123"
}
```

**响应**:
```json
{
  "success": true,
  "fileId": "file_1759114189482_jt19vrzqj",
  "fileName": "model.STEP",
  "fileUrl": "https://shopify-13s4.vercel.app/api/download-file?id=file_1759114189482_jt19vrzqj",
  "shopifyFileId": "gid://shopify/GenericFile/123456",
  "cdnUrl": "https://cdn.shopify.com/s/files/...",
  "fileSize": 683520,
  "message": "文件上传成功（Shopify Files 完整存储）"
}
```

#### POST /api/quotes

**请求体**:
```json
{
  "text": "model.STEP",
  "author": "张三",
  "email": "zhang@example.com",
  "status": "Pending",
  "price": "",
  "invoice_url": "https://shopify-13s4.vercel.app/api/download-file?id=file_xxx"
}
```

**响应**:
```json
{
  "id": "gid://shopify/Metaobject/169287057695",
  "handle": "zhang-example-com",
  "fields": [
    { "key": "text", "value": "model.STEP" },
    { "key": "author", "value": "张三 (zhang@example.com) | 数量:10件 | 材料:ABS | ..." },
    { "key": "status", "value": "Pending" },
    { "key": "price", "value": "" },
    { "key": "invoice_url", "value": "https://shopify-13s4.vercel.app/api/download-file?id=file_xxx" }
  ]
}
```

#### PATCH /api/quotes?handle=zhang-example-com

**请求体**:
```json
{
  "price": "1500.00",
  "status": "Quoted"
}
```

**响应**: 同 POST 响应格式

#### POST /api/send-email

**请求体**:
```json
{
  "customerEmail": "zhang@example.com",
  "senderEmail": "service@company.com",
  "amount": "1500.00",
  "fileName": "model.STEP",
  "notes": "预计交付时间：3-5个工作日"
}
```

**响应**:
```json
{
  "success": true,
  "mailto": "mailto:zhang@example.com?subject=...",
  "email": {
    "to": "zhang@example.com",
    "from": "service@company.com",
    "subject": "您的3D模型定制报价",
    "body": "尊敬的客户...",
    "html": "<html>...</html>"
  }
}
```

---

## 关键技术点

### 1. Base64 编码

**为什么使用 Base64？**
- 文件是二进制数据，无法直接在 JSON 中传输
- Base64 将二进制转换为文本格式
- 可以安全地通过 HTTP 传输

**示例**:
```javascript
// 读取文件
const file = event.target.files[0];
const reader = new FileReader();
reader.onload = function(e) {
  const base64Data = e.target.result; // "data:application/step;base64,U1RFUCBGSUxF..."
  // 发送到后端
};
reader.readAsDataURL(file);
```

### 2. Shopify Staged Upload

**为什么需要 Staged Upload？**
- 直接上传大文件到 Shopify API 会超时
- Staged Upload 分两步：先获取临时地址，再上传文件
- 文件上传到 Google Cloud Storage，速度更快

**流程**:
1. 调用 `stagedUploadsCreate` 获取临时 URL
2. 使用 HTTP POST 上传文件到临时 URL
3. 调用 `fileCreate` 创建永久记录
4. Shopify 自动将文件从临时地址移到永久存储

### 3. CORS (跨域资源共享)

**为什么需要 CORS？**
- 前端域名: `sain-pdc-test.myshopify.com`
- 后端域名: `shopify-13s4.vercel.app`
- 浏览器安全策略阻止跨域请求
- 必须在后端设置 CORS 头允许跨域

**设置**:
```javascript
res.setHeader('Access-Control-Allow-Origin', 'https://sain-pdc-test.myshopify.com');
res.setHeader('Access-Control-Allow-Methods', 'GET,POST,PATCH,DELETE,OPTIONS');
res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
```

### 4. GraphQL vs REST

**为什么使用 GraphQL？**
- Shopify Admin API 主要使用 GraphQL
- 可以精确指定需要的字段，减少数据传输
- 一次请求可以操作多个资源
- 类型安全，有完整的 schema 文档

**示例**:
```graphql
mutation {
  metaobjectCreate(metaobject: {
    type: "quote",
    fields: [
      { key: "text", value: "model.STEP" },
      { key: "author", value: "张三" }
    ]
  }) {
    metaobject {
      id
      handle
    }
    userErrors {
      field
      message
    }
  }
}
```

---

## 常见问题

### Q1: 为什么文件下载链接是 Vercel 域名而不是 Shopify？

**A**: 这是一个代理设计：
- 文件实际存储在 Shopify CDN
- 但通过 Vercel API (`/api/download-file`) 代理下载
- 好处：可以添加权限验证、日志记录等中间层逻辑
- 未来可以扩展为需要登录才能下载

### Q2: 为什么邮件不是自动发送，而是打开邮件客户端？

**A**: 技术和安全限制：
- Vercel Serverless Functions 不支持 SMTP 发送邮件
- 使用第三方邮件服务（如 SendGrid）需要额外配置和费用
- `mailto:` 方案简单可靠，无需额外服务
- 客服可以在发送前检查和修改邮件内容

### Q3: 为什么所有参数都存储在 author 字段？

**A**: Shopify Metaobject 限制：
- Metaobject 只支持预定义的字段
- 创建后无法动态添加新字段
- 如果为每个参数创建字段，会导致字段过多
- 序列化为字符串是最灵活的方案

### Q4: 如何处理大文件上传？

**A**: 使用 Shopify Staged Upload：
- 支持最大 100MB 文件
- 分步上传，避免超时
- 文件存储在 Google Cloud Storage
- 自动提供 CDN 加速

---

## 下一步学习

1. **阅读代码注释**: 每个核心文件都有详细的中文注释
2. **查看初学者指南**: `BEGINNER_GUIDE.md` 有更多概念解释
3. **实践操作**: 在测试环境中尝试完整流程
4. **调试技巧**: 使用浏览器开发者工具查看网络请求
5. **Shopify 文档**: 深入学习 Shopify GraphQL API

---

**文档版本**: 1.0  
**最后更新**: 2025-01-29  
**维护者**: AI Assistant

