# 🚀 Draft Order 方案 - 实施指南

## 📋 已完成的工作

### ✅ 创建的文件

1. **api/submit-quote.js** - 提交询价 API
   - 上传文件到 Shopify Files
   - 创建 Draft Order（占位价格 ¥0.01）
   - 创建 Metaobject（存储关联信息）

2. **api/update-quote.js** - 更新报价 API
   - 更新 Draft Order 价格
   - 更新 customAttributes（状态、备注）
   - 同步更新 Metaobject

3. **api/get-draft-order.js** - 获取 Draft Order API
   - 通过名称或 ID 查询
   - 返回格式化的询价详情

4. **templates/page.my-quotes.liquid** - 客户查看询价页面
   - 显示询价状态
   - 已报价时显示"立即下单"按钮
   - 点击跳转到 Shopify 结账页面

5. **templates/page.quote-request.liquid** - 简化的询价提交页面
   - 文件上传（拖拽/点击）
   - 填写定制参数
   - 提交询价

---

## 🔧 需要的配置

### 1. Shopify API 权限（已添加 ✅）

你已经添加了以下权限：
- ✅ `write_draft_orders` - 创建和更新草稿订单
- ✅ `read_draft_orders` - 读取草稿订单
- ✅ `write_files` - 上传文件
- ✅ `read_files` - 读取文件

### 2. Vercel 环境变量

确认以下环境变量已配置：
```bash
SHOPIFY_STORE_DOMAIN=your-store.myshopify.com
SHOPIFY_ACCESS_TOKEN=shpat_xxxxxxxxxxxxxxxx
```

### 3. API 基础 URL

在以下文件中，将 `API_BASE` 修改为你的 Vercel 域名：
- `templates/page.my-quotes.liquid` (第 245 行)
- `templates/page.quote-request.liquid` (第 348 行)

```javascript
const API_BASE = 'https://shopify-13s4.vercel.app/api';  // ← 修改这里
```

---

## 📁 文件部署清单

### Vercel 部署

上传以下文件到 Vercel：

```
api/
  ├── submit-quote.js       ✅ 新建
  ├── update-quote.js       ✅ 新建
  ├── get-draft-order.js    ✅ 新建
  ├── upload-file.js        ⚠️ 保留（可能还需要）
  ├── quotes-restored.js    ⚠️ 保留（旧版本，暂不删除）
  ├── send-email.js         ✅ 保留（仍需要）
  ├── download-file.js      ✅ 保留（仍需要）
  └── cleanup-files.js      ✅ 保留（仍需要）
```

### Shopify 主题上传

上传以下文件到 Shopify 主题：

```
templates/
  ├── page.quote-request.liquid    ✅ 新建
  ├── page.my-quotes.liquid        ✅ 新建
  ├── page.admin-dashboard.liquid  ⚠️ 需要修改（见下文）
  └── cart.quote.liquid            ⚠️ 旧版本（可以删除）

assets/
  └── model-uploader.js            ⚠️ 旧版本（暂不删除，备用）
```

---

## 🔄 完整工作流程

### 客户端流程

```
步骤 1: 提交询价
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
访问: /pages/quote-request

客户操作:
1. 上传 3D 模型文件
2. 填写参数（数量、材质、颜色）
3. 填写联系信息（姓名、邮箱）
4. 点击"提交询价"

系统操作:
5. 调用 POST /api/submit-quote
6. 上传文件 + 创建 Draft Order
7. 返回询价单号 (如 #D1001)
8. 跳转到 /pages/my-quotes?id=D1001


步骤 2: 查看询价状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
访问: /pages/my-quotes?id=D1001

系统操作:
1. 调用 GET /api/get-draft-order?id=D1001
2. 获取 Draft Order 详情
3. 显示状态（待报价/已报价）

待报价时显示:
- 🟡 待报价
- "客服正在为您报价，请稍候..."
- [刷新状态] 按钮

已报价时显示:
- 🟢 已报价
- 报价金额: ¥1,500
- 客服备注
- [🛒 立即下单] 按钮


步骤 3: 确认下单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
客户操作:
1. 点击"立即下单"

系统操作:
2. 跳转到 Draft Order 的 invoiceUrl
   (https://checkout.shopify.com/...)
3. 客户在 Shopify 结账页面看到:
   - 产品: 定制产品 - model.step
   - 单价: ¥1,500.00
   - 数量: 1
   - 总计: ¥1,500.00
4. 客户完成支付
5. Draft Order 自动转为正式订单
6. 订单状态: 待发货
```

---

### 管理端流程

```
步骤 1: 查看待报价订单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
访问: /pages/admin-dashboard

显示内容:
- 所有 Draft Order（状态: open）
- 筛选出 tags 包含 "pending" 的订单
- 显示客户信息、文件名、提交时间


步骤 2: 添加报价
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
客服操作:
1. 点击"添加报价"
2. 输入报价金额 (如 1500)
3. 输入备注 (如"根据您的要求...")
4. 输入发送邮箱 (客服自己的邮箱)
5. 点击"发送报价"

系统操作:
6. 调用 POST /api/update-quote
   {
     "draftOrderId": "gid://shopify/DraftOrder/...",
     "amount": 1500,
     "note": "根据您的要求...",
     "senderEmail": "service@company.com"
   }
7. 更新 Draft Order:
   - lineItems[0].originalUnitPrice = 1500
   - customAttributes["状态"] = "已报价"
   - customAttributes["报价金额"] = "¥1500"
   - customAttributes["备注"] = "..."
8. 同步更新 Metaobject:
   - status = "Quoted"
   - amount = 1500
9. 调用 POST /api/send-email
10. 发送邮件通知客户
```

---

## 🛠️ 管理后台修改指南

由于现有的 `page.admin-dashboard.liquid` 非常复杂，有两个选择：

### 选项 A: 创建新的管理页面（推荐）⭐

创建 `templates/page.admin-draft-orders.liquid`：

```liquid
<!-- 新的 Draft Order 管理页面 -->
<div id="admin-container">
  <h1>📋 Draft Order 管理</h1>
  
  <div id="draft-orders-list">
    <!-- 列表将通过 JavaScript 渲染 -->
  </div>
</div>

<script>
  const API_BASE = 'https://shopify-13s4.vercel.app/api';
  
  // 加载 Draft Orders
  async function loadDraftOrders() {
    // 通过 Shopify GraphQL API 查询所有 open 状态的 Draft Orders
    // 筛选出 tags 包含 "pending" 或 "quote" 的订单
    // 渲染列表
  }
  
  // 打开报价对话框
  function openQuoteDialog(draftOrder) {
    // 显示模态框
    // 输入报价金额、备注、客服邮箱
  }
  
  // 提交报价
  async function submitQuote(draftOrderId, amount, note, senderEmail) {
    const response = await fetch(`${API_BASE}/update-quote`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        draftOrderId,
        amount,
        note,
        senderEmail
      })
    });
    
    if (response.ok) {
      const result = await response.json();
      
      // 发送邮件
      await sendEmail(result);
      
      // 刷新列表
      loadDraftOrders();
    }
  }
  
  // 发送邮件
  async function sendEmail(result) {
    // 调用 send-email API
    // 显示邮件对话框
  }
</script>
```

---

### 选项 B: 修改现有管理页面

在 `page.admin-dashboard.liquid` 中修改 `sendQuoteEmail` 函数：

**找到这个函数** (大约在第 1368 行):

```javascript
async function sendQuoteEmail(orderId, customerEmail, senderEmail, files, amount, note) {
  // ... 现有代码
}
```

**在它之前添加新函数**:

```javascript
// 新增：更新 Draft Order 报价
async function updateDraftOrderQuote(draftOrderId, amount, note, senderEmail) {
  try {
    const response = await fetch(`${QUOTES_API_BASE}/update-quote`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        draftOrderId,
        amount: parseFloat(amount),
        note,
        senderEmail
      })
    });
    
    if (!response.ok) {
      throw new Error('更新报价失败');
    }
    
    const result = await response.json();
    console.log('✅ Draft Order 更新成功:', result);
    
    return result;
  } catch (error) {
    console.error('❌ 更新报价失败:', error);
    throw error;
  }
}
```

**修改提交报价的逻辑**:

找到 `submitQuote` 或类似的提交函数，在更新 Metaobject 之后，添加：

```javascript
// 如果订单有 draft_order_id，则更新 Draft Order
if (order.properties.fields.draft_order_id) {
  try {
    await updateDraftOrderQuote(
      order.properties.fields.draft_order_id,
      amount,
      note,
      senderEmail
    );
    console.log('✅ Draft Order 价格已更新');
  } catch (error) {
    console.warn('⚠️ Draft Order 更新失败（非致命错误）:', error);
  }
}
```

---

## 🧪 测试清单

### 1. API 测试

#### 测试 submit-quote

```bash
curl -X POST https://shopify-13s4.vercel.app/api/submit-quote \
  -H "Content-Type: application/json" \
  -d '{
    "fileName": "test.step",
    "fileData": "data:application/octet-stream;base64,VEVTVCBGSUxF",
    "customerEmail": "test@example.com",
    "customerName": "测试用户",
    "quantity": 100,
    "material": "ABS",
    "color": "白色"
  }'
```

**预期响应**:
```json
{
  "success": true,
  "quoteId": "#D1001",
  "draftOrderId": "gid://shopify/DraftOrder/...",
  "invoiceUrl": "https://checkout.shopify.com/...",
  "message": "询价提交成功！"
}
```

#### 测试 get-draft-order

```bash
curl "https://shopify-13s4.vercel.app/api/get-draft-order?id=%23D1001"
```

**预期响应**:
```json
{
  "success": true,
  "draftOrder": {
    "name": "#D1001",
    "status": "待报价",
    "totalPrice": "0.01",
    ...
  }
}
```

#### 测试 update-quote

```bash
curl -X POST https://shopify-13s4.vercel.app/api/update-quote \
  -H "Content-Type: application/json" \
  -d '{
    "draftOrderId": "gid://shopify/DraftOrder/...",
    "amount": 1500,
    "note": "测试报价"
  }'
```

**预期响应**:
```json
{
  "success": true,
  "draftOrderName": "#D1001",
  "totalPrice": "1500.00",
  "message": "报价更新成功"
}
```

---

### 2. 前端测试

#### 测试客户提交询价

1. 访问: `https://your-store.myshopify.com/pages/quote-request`
2. 上传文件（如 `test.step`）
3. 填写参数
4. 点击"提交询价"
5. 验证:
   - ✅ 提示"询价提交成功"
   - ✅ 显示询价单号 (如 #D1001)
   - ✅ 跳转到 `/pages/my-quotes?id=D1001`

#### 测试客户查看询价

1. 访问: `https://your-store.myshopify.com/pages/my-quotes?id=D1001`
2. 验证:
   - ✅ 显示询价单号
   - ✅ 显示状态 "🟡 待报价"
   - ✅ 显示文件名、参数
   - ✅ 显示"刷新状态"按钮

#### 测试客服添加报价

1. 在 Shopify 后台或通过 API 更新报价
2. 刷新客户页面
3. 验证:
   - ✅ 状态变为 "🟢 已报价"
   - ✅ 显示报价金额
   - ✅ 显示"立即下单"按钮

#### 测试客户下单

1. 点击"立即下单"
2. 验证:
   - ✅ 跳转到 Shopify 结账页面
   - ✅ 显示正确的产品和价格
   - ✅ 完成支付后订单创建成功

---

### 3. 后台验证

#### 在 Shopify 后台查看

1. **Draft Orders**:
   - 订单 → 草稿订单
   - 验证:
     - ✅ 可以看到新创建的草稿订单
     - ✅ 订单号格式为 #D1001
     - ✅ 状态为 "Open"
     - ✅ Tags 包含 "quote", "pending"

2. **Files**:
   - 内容 → 文件
   - 验证:
     - ✅ 可以看到上传的文件
     - ✅ 文件可以下载

3. **Metaobjects** (可选):
   - 设置 → 自定义数据 → Metaobjects
   - 验证:
     - ✅ 可以看到 quote 类型的 Metaobject
     - ✅ 字段包含 draft_order_id, status, amount 等

---

## 🐛 常见问题

### Q1: API 返回 401 错误

**原因**: Shopify API 令牌无效或权限不足

**解决方案**:
1. 检查 Vercel 环境变量
2. 确认 `SHOPIFY_ACCESS_TOKEN` 正确
3. 确认已添加 `write_draft_orders` 权限

---

### Q2: Draft Order 创建成功但价格是 ¥0.01

**原因**: 这是正常的，占位价格

**解决方案**:
- 客服添加报价后，价格会更新为实际报价
- 客户下单时看到的是更新后的价格

---

### Q3: 文件上传失败

**原因**: 文件过大或格式不支持

**解决方案**:
1. 限制文件大小 (建议 < 100MB)
2. 验证文件格式
3. 检查 Vercel 函数超时设置（默认 10 秒）

---

### Q4: 客户点击"立即下单"后看不到正确的价格

**原因**: Draft Order 没有正确更新

**解决方案**:
1. 检查 `update-quote` API 日志
2. 确认 `originalUnitPrice` 已更新
3. 尝试在 Shopify 后台手动查看 Draft Order

---

### Q5: 邮件没有发送

**原因**: `send-email` API 使用 `mailto:` 协议

**说明**:
- `mailto:` 只是打开邮件客户端
- 客服需要手动点击"发送"
- 或者使用"复制邮件内容"功能

**升级方案**:
- 使用 Resend/SendGrid 实现真正的自动发送
- 参考 `EMAIL_SOLUTIONS_COMPARISON.md`

---

## 📚 相关文档

- [FINAL_DRAFT_ORDER_SOLUTION.md](./FINAL_DRAFT_ORDER_SOLUTION.md) - 完整方案说明
- [NEW_QUOTE_WORKFLOW.md](./NEW_QUOTE_WORKFLOW.md) - 工作流程详解
- [DRAFT_ORDER_CLARIFICATION.md](./DRAFT_ORDER_CLARIFICATION.md) - Draft Order 澄清
- [EMAIL_SOLUTIONS_COMPARISON.md](./EMAIL_SOLUTIONS_COMPARISON.md) - 邮件方案对比

---

## 🎯 下一步

1. **部署到 Vercel**:
   ```bash
   # 提交代码
   git add .
   git commit -m "feat: 实施 Draft Order 报价方案"
   git push
   
   # Vercel 自动部署
   ```

2. **上传到 Shopify 主题**:
   - 使用 Shopify CLI 或主题编辑器
   - 上传 `page.quote-request.liquid`
   - 上传 `page.my-quotes.liquid`

3. **创建 Shopify 页面**:
   - 在线商店 → 页面 → 添加页面
   - 标题: "询价请求"
   - 模板: `page.quote-request`
   - URL: `/pages/quote-request`
   
   - 标题: "我的询价"
   - 模板: `page.my-quotes`
   - URL: `/pages/my-quotes`

4. **测试完整流程**:
   - 按照上面的测试清单逐项测试
   - 记录任何问题

5. **投入使用**:
   - 培训客服使用新系统
   - 监控订单流程
   - 收集用户反馈

---

**实施完成！** 🎉

如有任何问题，请查看相关文档或联系支持。

