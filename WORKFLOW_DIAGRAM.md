# 📊 完整业务流程图

## 🎯 核心流程：立即询价 → 草稿订单 → 立即下单 → 购物车 → 立即付款

---

## 📱 客户端流程

```
┌──────────────────────────────────────────┐
│         1. 上传页面                       │
│    /pages/model-uploader                 │
│                                          │
│  ┌────────────────────────────────┐     │
│  │  • 上传3D文件（.stp/.step）    │     │
│  │  • 选择材料、精度、公差        │     │
│  │  • 填写数量、备注              │     │
│  │  • 登录验证                    │     │
│  └────────────────────────────────┘     │
│              ↓                           │
│      [点击"立即询价"]                    │
└──────────────┬───────────────────────────┘
               │
               │ API调用: POST /api/submit-quote-real
               │ 创建Shopify草稿订单
               │
               ↓
┌──────────────────────────────────────────┐
│         2. 草稿订单详情页                 │
│    /pages/my-quotes?id=D123456           │
│                                          │
│  ┌────────────────────────────────┐     │
│  │  订单 #D123456                 │     │
│  │  状态: 待报价 ⏳               │     │
│  │  ──────────────────────────    │     │
│  │  零件名称: part1.stp           │     │
│  │  数量: 1                       │     │
│  │  材料: PLA                     │     │
│  │  精度: 标准 (±0.1mm)           │     │
│  │  公差: GB/T 1804-2000 m级     │     │
│  │  ──────────────────────────    │     │
│  │  小计: ¥0.00 (待报价)          │     │
│  │  总计: ¥0.00                   │     │
│  │                                │     │
│  │  [继续上传] [等待报价]         │     │
│  └────────────────────────────────┘     │
└──────────────┬───────────────────────────┘
               │
               │ 🔄 客服报价完成
               │ API调用: POST /api/update-quote
               │
               ↓
┌──────────────────────────────────────────┐
│         3. 报价完成状态                   │
│    /pages/my-quotes?id=D123456           │
│                                          │
│  ┌────────────────────────────────┐     │
│  │  订单 #D123456                 │     │
│  │  状态: 已报价 ✅               │     │
│  │  ──────────────────────────    │     │
│  │  零件名称: part1.stp           │     │
│  │  数量: 1                       │     │
│  │  材料: PLA                     │     │
│  │  精度: 标准 (±0.1mm)           │     │
│  │  公差: GB/T 1804-2000 m级     │     │
│  │  ──────────────────────────    │     │
│  │  小计: ¥199.00 ✅              │     │
│  │  运费: 待确定                   │     │
│  │  总计: ¥199.00                 │     │
│  │                                │     │
│  │  [继续上传] [立即下单] ← 可点击 │     │
│  └────────────────────────────────┘     │
└──────────────┬───────────────────────────┘
               │
               │ [点击"立即下单"]
               │ API调用: POST /cart/add.js
               │ 将草稿订单项目添加到购物车
               │
               ↓
┌──────────────────────────────────────────┐
│         4. 购物车页面                     │
│    /cart?view=quote                      │
│                                          │
│  ┌────────────────────────────────┐     │
│  │  询价清单                       │     │
│  │  ──────────────────────────    │     │
│  │  ┌──────────────────────┐      │     │
│  │  │ [图] part1.stp       │      │     │
│  │  │ 数量: 1              │      │     │
│  │  │ 材料: PLA            │ 已报价│     │
│  │  │ 精度: 标准           │      │     │
│  │  └──────────────────────┘      │     │
│  │                                │     │
│  │  [继续上传] [立即付款]         │     │
│  └────────────────────────────────┘     │
└──────────────┬───────────────────────────┘
               │
               │ [点击"立即付款"]
               │ Shopify原生结账流程
               │
               ↓
┌──────────────────────────────────────────┐
│         5. Shopify结账页面                │
│    /checkout                             │
│                                          │
│  ┌────────────────────────────────┐     │
│  │  • 填写配送地址                 │     │
│  │  • 选择配送方式                 │     │
│  │  • 填写支付信息                 │     │
│  │  • 确认订单                     │     │
│  └────────────────────────────────┘     │
│              ↓                           │
│      [完成支付]                          │
└──────────────┬───────────────────────────┘
               │
               ↓
┌──────────────────────────────────────────┐
│         6. 订单完成                       │
│    /thank_you                            │
│                                          │
│  ✅ 支付成功！                           │
│  订单号: #1234                           │
│  我们会尽快开始制作您的零件              │
└──────────────────────────────────────────┘
```

---

## 👨‍💼 管理端流程

```
┌──────────────────────────────────────────┐
│         1. 登录后台                       │
│    /pages/admin-draft-orders             │
│                                          │
│  ┌────────────────────────────────┐     │
│  │  输入客服账号密码               │     │
│  │  [登录]                         │     │
│  └────────────────────────────────┘     │
└──────────────┬───────────────────────────┘
               │
               ↓
┌──────────────────────────────────────────┐
│         2. 订单管理界面                   │
│    /pages/admin-draft-orders             │
│                                          │
│  ┌────────────────────────────────┐     │
│  │  📋 Draft Order 报价管理        │     │
│  │  [🔄 刷新] [⚡ 快速报价]        │     │
│  └────────────────────────────────┘     │
│                                          │
│  ┌─────┐ ┌─────┐ ┌─────┐               │
│  │ ⏳  │ │ ✅  │ │ 📊  │               │
│  │  5  │ │  3  │ │  8  │               │
│  │待报价│ │已报价│ │总计 │               │
│  └─────┘ └─────┘ └─────┘               │
│                                          │
│  [全部] [待报价] [已报价]               │
│                                          │
│  ┌────────────────────────────────┐     │
│  │ 订单 #D123456    待报价         │     │
│  │ 张三 (zhangsan@example.com)    │     │
│  │ part1.stp                       │     │
│  │ 2025-10-16 10:30               │     │
│  │ [⬇️] [👁️] [💰] [📋] [🗑️]        │     │
│  └────────────────────────────────┘     │
│                                          │
│  ┌────────────────────────────────┐     │
│  │ 订单 #D123457    已报价         │     │
│  │ 李四 (lisi@example.com)        │     │
│  │ part2.stp                       │     │
│  │ 2025-10-16 09:15               │     │
│  │ [⬇️] [👁️] [💰] [📋] [🗑️]        │     │
│  └────────────────────────────────┘     │
└──────────────┬───────────────────────────┘
               │
               │ [点击 💰 报价按钮]
               │
               ↓
┌──────────────────────────────────────────┐
│         3. 报价模态框                     │
│                                          │
│  ┌────────────────────────────────┐     │
│  │  添加报价              [×]      │     │
│  │  ──────────────────────────    │     │
│  │  询价单号: #D123456            │     │
│  │  客户邮箱: zhangsan@example.com│     │
│  │                                │     │
│  │  报价金额 (¥):                 │     │
│  │  [ 199.00 ]                    │     │
│  │                                │     │
│  │  备注:                         │     │
│  │  [材料费150元+加工费49元]     │     │
│  │                                │     │
│  │      [取消] [确认报价]         │     │
│  └────────────────────────────────┘     │
└──────────────┬───────────────────────────┘
               │
               │ [点击"确认报价"]
               │ API调用: POST /api/update-quote
               │ 更新草稿订单价格
               │
               ↓
┌──────────────────────────────────────────┐
│         4. 报价成功                       │
│                                          │
│  ✅ 报价提交成功！                       │
│                                          │
│  订单 #D123456 已更新为"已报价"状态      │
│  客户可以在详情页查看报价并下单          │
└──────────────────────────────────────────┘
```

---

## 🔄 数据流转

### 1. 创建草稿订单
```
客户端                      Vercel API                  Shopify API
  │                            │                           │
  │ POST /submit-quote-real   │                           │
  ├───────────────────────────>│                           │
  │                            │ draftOrderCreate mutation │
  │                            ├──────────────────────────>│
  │                            │                           │
  │                            │<──────────────────────────┤
  │                            │ Draft Order Created       │
  │<───────────────────────────┤                           │
  │ { draftOrderId: "xxx" }   │                           │
  │                            │                           │
```

### 2. 客服报价
```
管理端                      Vercel API                  Shopify API
  │                            │                           │
  │ POST /update-quote        │                           │
  ├───────────────────────────>│                           │
  │ { draftOrderId, amount }  │                           │
  │                            │ draftOrderUpdate mutation │
  │                            ├──────────────────────────>│
  │                            │                           │
  │                            │<──────────────────────────┤
  │                            │ Updated                   │
  │<───────────────────────────┤                           │
  │ { success: true }         │                           │
  │                            │                           │
```

### 3. 客户下单
```
客户端                      Shopify Cart API
  │                            │
  │ POST /cart/add.js         │
  ├───────────────────────────>│
  │ { items: [...] }          │
  │                            │
  │<───────────────────────────┤
  │ Cart Updated              │
  │                            │
  │ Redirect to /cart         │
  │                            │
```

---

## 📦 数据结构

### 草稿订单数据
```javascript
{
  id: "gid://shopify/DraftOrder/123456",
  name: "#D123456",
  email: "zhangsan@example.com",
  status: "pending", // 或 "quoted"
  totalPrice: 199.00,
  createdAt: "2025-10-16T10:30:00Z",
  lineItems: [
    {
      title: "part1.stp",
      quantity: 1,
      price: 199.00,
      customAttributes: [
        { key: "材料", value: "PLA" },
        { key: "精度等级", value: "标准 (±0.1mm)" },
        { key: "公差标准", value: "GB/T 1804-2000 m级" },
        // ... 更多属性
      ]
    }
  ]
}
```

### 购物车项目数据
```javascript
{
  id: 44738234089744, // 产品变体ID
  quantity: 1,
  properties: {
    'Order Type': '3D Model Quote',
    'Draft Order ID': 'D123456',
    'Quote Status': 'Quoted',
    'Quoted Price': '199.00',
    '客户姓名': '张三',
    '客户邮箱': 'zhangsan@example.com',
    '材料': 'PLA',
    '精度等级': '标准 (±0.1mm)',
    // ... 更多属性
  }
}
```

---

## 🎯 状态转换图

```
待报价 (Pending)
    ↓ 客服提交报价
已报价 (Quoted)
    ↓ 客户点击"立即下单"
在购物车 (In Cart)
    ↓ 客户点击"立即付款"
待付款 (Pending Payment)
    ↓ 完成支付
已付款 (Paid)
    ↓ 开始生产
生产中 (In Production)
    ↓ 完成生产
待发货 (Ready to Ship)
    ↓ 发货
已发货 (Shipped)
    ↓ 客户收货
已完成 (Completed)
```

---

## 🔐 权限控制

```
角色          可访问页面                        权限
────────────────────────────────────────────────
客户          /pages/model-uploader             上传文件、查看自己的订单
              /pages/my-quotes?id=xxx           
              /cart                             

客服          /pages/admin-draft-orders         查看所有订单、报价、下载文件、
                                                删除订单

管理员        所有页面                          完整权限
```

---

## 💡 关键技术点

### 1. 草稿订单 vs 购物车
- **草稿订单**: 用于询价阶段，价格可以为0，灵活修改
- **购物车**: 用于下单阶段，集成Shopify原生结账流程

### 2. 数据同步
- 草稿订单状态通过API实时同步
- 购物车数据使用Shopify原生API管理
- 订单信息通过`customAttributes`传递

### 3. 文件管理
- 文件上传到Shopify Metaobjects
- 文件ID存储在`customAttributes`中
- 客服可以从后台下载原始文件

### 4. 状态追踪
- 草稿订单: `pending` → `quoted`
- 购物车: 自动同步Shopify订单状态
- 支付: Shopify原生订单管理

---

这个流程完美地结合了：
✅ **草稿订单的灵活性**（适合询价）
✅ **购物车API的成熟度**（适合下单）
✅ **Shopify原生结账**（适合支付）

实现了一个完整、稳定、易用的定制化询价系统！🎉

